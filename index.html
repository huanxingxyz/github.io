<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>田鹏飞的个人博客</title>
  <meta name="author" content="huanxingxyz">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="田鹏飞的个人博客"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/bootstrap.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">田鹏飞的个人博客</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header page-header-inverse ">
  <h1 class="title title-inverse ">你若盛开，蝴蝶自来</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      Yet another bootstrap theme.
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-05-14 </div>
			<div class="article-title"><a href="/2016/05/14/Android_条码扫描二维码扫描/" >Android_条码扫描二维码</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>前言<br>　　最近公司的Android项目需要用到摄像头做条码或二维码的扫描，Google一下，发现一个以Apache License 2.0 开源的 ZXing项目。Zxing项目里的Android实现太过复杂多余东西太多，得对其进行简化。</p>
<p>前提条件<br>　　下载源代码：点击这里</p>
<p>　　编译核心库：Zxing的主页上有介绍具体步骤，大家也可以参照这篇博文：android 条码识别软件开发全解析(续2详解绝杀！)</p>
<p>导入项目<br>　　打开Eclipse 导入 源码中的 Android 项目，然后右击项目 选择“Build path”——》”Add External Archives” 把核心库 core.jar文件加入到项目中。</p>
<p>此时编译一下项目，会发现报错,“ Multiple substitutions specified in non-positional format; did you mean to add the formatted=”false” attribute?”之类的。打开raw 下的Values 发现错误是在一个<string>上。这里把 “preferences_custom_product_search_summary” 里的  %s  %f  全部都改成  %1$s  %1$f（因为我们用不到多国语言，建议只保留默认的Value ，其他全部删除）。</string></p>
<p>　　原因：由于新的SDK采用了新版本的aapt（Android项目编译器），这个版本的aapt编译起来会比老版本更加的严格，然后在Android最新的开发文档的描述String的部分，已经说明如何去设置 %s 等符号</p>
<p>　　“If you need to format your strings using String.format(String, Object…) , then you can do so by putting your format arguments in the string resource. For example, with the following resource:</p>
<p>　　<string name="welcome_messages">Hello, %1$s! You have %2$d new messages.</string></p>
<p>　　In this example, the format string has two arguments: %1$s is a string and %2$d is a decimal number. You can format the string with arguements from your application…“</p>
<p>　　经过以上步骤后项目应该就可以运行了。</p>
<p>　　但是ZXing的android项目东西太多了，有很多是我们不需要的，得新建另一个项目简化它。</p>
<p>简化<br>　　在开始前大致介绍一下简化ZXing需要用到各个包 、类的职责。</p>
<p>CaptureActivity。这个是启动Activity 也就是扫描器（如果是第一安装，它还会跳转到帮助界面）。<br>CaptureActivityHandler 解码处理类，负责调用另外的线程进行解码。<br>DecodeThread 解码的线程。<br>com.google.zxing.client.android.camera 包，摄像头控制包。<br>ViewfinderView 自定义的View，就是我们看见的拍摄时中间的框框了。<br>新建另一个项目<br>　　新建另一个项目将启动的Activity命名为CaptureActivity，并导入核心库。项目新建完成后我们打开 CaptureActivity 的布局文件，我这里为main。把里面的XML修改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">复制代码</span><br><span class="line">1 &lt;FrameLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">2 android:layout_width=&quot;fill_parent&quot; android:layout_height=&quot;fill_parent&quot;&gt;</span><br><span class="line">3 &lt;SurfaceView android:id=&quot;@+id/preview_view&quot;</span><br><span class="line">4 android:layout_width=&quot;fill_parent&quot; android:layout_height=&quot;fill_parent&quot;</span><br><span class="line">5 android:layout_centerInParent=&quot;true&quot;/&gt;</span><br><span class="line">6 </span><br><span class="line">7 &lt;com.Zxing.Demo.view.ViewfinderView</span><br><span class="line">8 android:id=&quot;@+id/viewfinder_view&quot; android:layout_width=&quot;fill_parent&quot;</span><br><span class="line">9 android:layout_height=&quot;fill_parent&quot; android:background=&quot;@android:color/transparent&quot;/&gt;</span><br><span class="line">10 &lt;TextView android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">11 android:id=&quot;@+id/txtResult&quot;</span><br><span class="line">12 android:layout_height=&quot;wrap_content&quot; android:text=&quot;@string/hello&quot;/&gt;</span><br><span class="line">13 </span><br><span class="line">14  &lt;/FrameLayout&gt;</span><br></pre></td></tr></table></figure>
<p>复制代码<br>　　可以看到在XML里面用到了 ViewfinderView 自定义view 。所以新建一个View 的包，然后把：ViewfinderView 和 ViewfinderResultPointCallback 靠到里面（记得对应修改XML里面的包）。</p>
<p>打开 CaptureActivity 覆盖 onCreate 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">复制代码</span><br><span class="line">1 @Override</span><br><span class="line">2 publicvoid onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">3 super.onCreate(savedInstanceState);</span><br><span class="line">4 setContentView(R.layout.main);</span><br><span class="line">5 //初始化 CameraManager</span><br><span class="line">6   CameraManager.init(getApplication());</span><br><span class="line">7 </span><br><span class="line">8 viewfinderView = (ViewfinderView) findViewById(R.id.viewfinder_view);</span><br><span class="line">9 txtResult = (TextView) findViewById(R.id.txtResult);</span><br><span class="line">10 hasSurface =false;</span><br><span class="line">11 inactivityTimer =new InactivityTimer(this);</span><br><span class="line">12 &#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>  这里调用到的 CameraManager 类是控制摄像头的包里的类。新建一个camera包把：com.google.zxing.client.android.camera 里面的类全部拷入，另外我把PlanarYUVLuminanceSource也拷入到这个包里面。根据错误的提示来修正代码，主要是修改正包结构。（整个简化的流程都是如此：“根据错误提示，修改代码”）。</p>
<p>　　在修改的过程中，有很多是关于R 资源的问题，在此我们需要将Values  里面的两个xml资源文件拷入项目中：colos.xml 和ids.xml 。 ctrl+b 一下看看error 是不是少了很多。在CameraManager中有些地方需要用到项目的配置，这里需要把配置直接写入代码中：<br>　　<br>　　<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">　　</span><br><span class="line"></span><br><span class="line">// SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);</span><br><span class="line">//是否使用前灯</span><br><span class="line">// if (prefs.getBoolean(PreferencesActivity.KEY_FRONT_LIGHT, false)) &#123;</span><br><span class="line">// FlashlightManager.enableFlashlight();</span><br><span class="line">// &#125;</span><br><span class="line">FlashlightManager.enableFlashlight();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 　　使用摄像头需要加入相应的权限：</span><br></pre></td></tr></table></figure></p>
<p><uses-permission android:name="android.permission.CAMERA"></uses-permission></p>
<p><uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"></uses-permission></p>
<p><uses-feature android:name="android.hardware.camera"></uses-feature></p>
<p><uses-feature android:name="android.hardware.camera.autofocus"></uses-feature></p>
<p><uses-permission android:name="android.permission.VIBRATE"></uses-permission></p>
<uses-permission android:name="android.permission.FLASHLIGHT">

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">　　当View 和 camera 包里的错误修正完成后，我们继续来看CaptureActivity。</span><br><span class="line"></span><br><span class="line">覆盖onResume方法初始化摄像头：</span><br></pre></td></tr></table></figure>
<p>复制代码<br>@Override<br>protectedvoid onResume() {<br>super.onResume();<br>SurfaceView surfaceView = (SurfaceView) findViewById(R.id.preview_view);<br>SurfaceHolder surfaceHolder = surfaceView.getHolder();<br>if (hasSurface) {<br>initCamera(surfaceHolder);<br>} else {<br>surfaceHolder.addCallback(this);<br>surfaceHolder.setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);<br>}<br>decodeFormats =null;<br>characterSet =null;</p>
<p>playBeep =true;<br>AudioManager audioService = (AudioManager) getSystemService(AUDIO_SERVICE);<br>if (audioService.getRingerMode() != AudioManager.RINGER_MODE_NORMAL) {<br>playBeep =false;<br>}<br>initBeepSound();<br>vibrate =true;<br>}</p>
<p>复制代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">initCamera</span><br><span class="line">SurfaceHolder接口实现</span><br><span class="line">initCamera () 方法用于初始化摄像头，如果排除了所有的error ，运行项目时就可以看到大致扫描界面了。 surfaceHolder.addCallback(this);表示让CaptureActivity实现其callback接口。</span><br><span class="line"></span><br><span class="line">handler = new CaptureActivityHandler(this, decodeFormats,characterSet) 用于进行扫描解码处理。</span><br><span class="line"></span><br><span class="line">解码</span><br><span class="line">　　上面的步骤主要都是用于对摄像头的控制，而解码的真正工作入口是在CaptureActivityHandler 里面的。新建一个Decoding包把以下文件拷入包中：</span><br><span class="line"></span><br><span class="line">CaptureActivityHandler</span><br><span class="line">DecodeFormatManager</span><br><span class="line">DecodeHandler</span><br><span class="line">DecodeThread</span><br><span class="line">FinishListener</span><br><span class="line">InactivityTimer</span><br><span class="line">Intents</span><br><span class="line">由于我们的包结构和Zxing 项目的有所不同所以需要注意一下类的可访问性</span><br><span class="line"></span><br><span class="line">同样开始ctrl+B 编译一下，然后开始修正错误。</span><br><span class="line"></span><br><span class="line">　　在CaptureActivityHandler 里 把 handleMessage 里的部分方法先注释掉如：“decode_succeeded ”分支，这是解码成功时调用 CaptureActivity 展示解码的结果。</span><br><span class="line"></span><br><span class="line">在DecodeThread 类里，修改部分涉及Preference配置的代码：</span><br></pre></td></tr></table></figure>
<p>复制代码<br>DecodeThread(CaptureActivity activity,<br>Vector<barcodeformat> decodeFormats,<br>String characterSet,<br>ResultPointCallback resultPointCallback) {</barcodeformat></p>
<p>this.activity = activity;<br>handlerInitLatch =new CountDownLatch(1);</p>
<p>hints =new Hashtable<decodehinttype, object="">(3);</decodehinttype,></p>
<p>//// The prefs can’t change while the thread is running, so pick them up once here.<br>// if (decodeFormats == null || decodeFormats.isEmpty()) {<br>// SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(activity);<br>// decodeFormats = new Vector<barcodeformat>();<br>// if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_1D, true)) {<br>// decodeFormats.addAll(DecodeFormatManager.ONE_D_FORMATS);<br>// }<br>// if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_QR, true)) {<br>// decodeFormats.addAll(DecodeFormatManager.QR_CODE_FORMATS);<br>// }<br>// if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_DATA_MATRIX, true)) {<br>// decodeFormats.addAll(DecodeFormatManager.DATA_MATRIX_FORMATS);<br>// }<br>// }<br>if (decodeFormats ==null|| decodeFormats.isEmpty()) {<br>decodeFormats =new Vector<barcodeformat>();<br>decodeFormats.addAll(DecodeFormatManager.ONE_D_FORMATS);<br>decodeFormats.addAll(DecodeFormatManager.QR_CODE_FORMATS);<br>decodeFormats.addAll(DecodeFormatManager.DATA_MATRIX_FORMATS);</barcodeformat></barcodeformat></p>
<p>}</p>
<p>hints.put(DecodeHintType.POSSIBLE_FORMATS, decodeFormats);</p>
<p>if (characterSet !=null) {<br>hints.put(DecodeHintType.CHARACTER_SET, characterSet);<br>}</p>
<p>hints.put(DecodeHintType.NEED_RESULT_POINT_CALLBACK, resultPointCallback);<br>}<br>复制代码</p>
<p>```</p>
<p>这里是设置 解码的类型，我们现在默认将所有类型都加入。</p>
<p>错误类型基本上都是：包结构、PreferencesActivity 的配置 、类可访问性的问题。根据错误提示耐心把错误解决。</p>
<p>返回解码结果<br> 　　还记得在 CaptureActivityHandler 的 messagehandler 里注销掉的Case分支吗？现在CaptureActivity 里实现它。</p>
<p>复制代码<br>publicvoid handleDecode(Result obj, Bitmap barcode) {<br>inactivityTimer.onActivity();<br>viewfinderView.drawResultBitmap(barcode);<br>playBeepSoundAndVibrate();<br>txtResult.setText(obj.getBarcodeFormat().toString() +”:”</p>
<ul>
<li>obj.getText());<br>}<br>复制代码<br>最后<br>　　ZXing的简化已基本完成，有几位是可以运行成功的？呵呵。</li>
</ul>
<p>下面是CaptureActivity的源码:</p>
<p>CaputreActivity<br>简化过的包结构图：</p>
<p>　</p>
<p>　简化后的ZXing 更加方便我们了解ZXing项目 是如何解码的。只要仔细查看源码，进行单点跟踪调试，相信大家很容易能理解。</p>
<p>顾客是上帝<br>   很多人留言要源码， 其实我这不是什么源码，我只是把ZXing的东西简化了一下而已。事实上我也不喜欢直接放源码项目，这样大家就不想读ZXing的源码了。</p>
<p>下面是我简化的版本：Zxing简化</p>
<p>很多人需要Core 核心包（其实ZXing的源码里面就有），这里提供下我写文章时的版本 1.6的：</p>
<p>Zxing</p>
</uses-permission>
	
	</div>
  <a type="button" href="/2016/05/14/Android_条码扫描二维码扫描/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-05-14 </div>
			<div class="article-title"><a href="/2016/05/14/Android_Afinal框架/" >Android_Afinal框架</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>Afinal简介<br>Afinal是一个android的ioc，orm框架，内置了四大模块功能：FinalAcitivity,FinalBitmap,FinalDb,FinalHttp。通过finalActivity，我们可以通过注解的方式进行绑定ui和事件。通过finalBitmap，我们可以方便的加载bitmap图片，而无需考虑oom等问题。通过finalDB模块，我们一行代码就可以对android的sqlite数据库进行增删改查。通过FinalHttp模块，我们可以以ajax形式请求http数据。详情请通过以下网址查看。 — More…</p>
<p>Afinal 是一个android的sqlite orm 和 ioc 框架。同时封装了android中的http框架，使其更加简单易用；<br>使用finalBitmap，无需考虑bitmap在android中加载的时候oom的问题和快速滑动的时候图片加载位置错位等问题。<br>Afinal的宗旨是简洁，快速。约定大于配置的方式。尽量一行代码完成所有事情。<br>目前Afinal主要有四大模块：</p>
<p>FinalDB模块：android中的orm框架，一行代码就可以进行增删改查。支持一对多，多对一等查询。</p>
<p>FinalActivity模块：android中的ioc框架，完全注解方式就可以进行UI绑定和事件绑定。无需findViewById和setClickListener等。</p>
<p>FinalHttp模块：通过httpclient进行封装http数据请求，支持ajax方式加载。</p>
<p>FinalBitmap模块：通过FinalBitmap，imageview加载bitmap的时候无需考虑bitmap加载过程中出现的oom和android容器快速滑动时候出现的图片错位等现象。FinalBitmap可以配置线程加载线程数量，缓存大小，缓存路径，加载显示动画等。FinalBitmap的内存管理使用lru算法，没有使用弱引用（android2.3以后google已经不建议使用弱引用，android2.3后强行回收软引用和弱引用，详情查看android官方文档），更好的管理bitmap内存。FinalBitmap可以自定义下载器，用来扩展其他协议显示网络图片，比如ftp等。同时可以自定义bitmap显示器，在imageview显示图片的时候播放动画等（默认是渐变动画显示）。</p>
<p>使用afinal快速开发框架需要有以下权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;</span><br><span class="line">2</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot; /&gt;</span><br></pre></td></tr></table></figure>
<p>第一个是访问网络<br>第二个是访问sdcard<br>访问网络是请求网络图片的时候需要或者是http数据请求时候需要，访问sdcard是图片缓存的需要。<br>FinalDB使用方法</p>
<p>关于finalDb的更多介绍，请点击这里</p>
<p>1<br>FinalDb db = FinalDb.create(this);<br>2<br>User user = new User(); //这里需要注意的是User对象必须有id属性，或者有通过@ID注解的属性<br>3<br>user.setEmail(“mail@tsz.net”);<br>4<br>user.setName(“michael yang”);<br>5<br>db.save(user);<br>FinalActivity使用方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">完全注解方式就可以进行UI绑定和事件绑定</span><br><span class="line">无需findViewById和setClickListener等</span><br><span class="line">01</span><br><span class="line">public class AfinalDemoActivity extends FinalActivity &#123;</span><br><span class="line">02</span><br><span class="line"></span><br><span class="line">03</span><br><span class="line">    //无需调用findViewById和setOnclickListener等</span><br><span class="line">04</span><br><span class="line">    @ViewInject(id=R.id.button,click=&quot;btnClick&quot;) Button button;</span><br><span class="line">05</span><br><span class="line">    @ViewInject(id=R.id.textView) TextView textView;</span><br><span class="line">06</span><br><span class="line"></span><br><span class="line">07</span><br><span class="line">    public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">08</span><br><span class="line">       super.onCreate(savedInstanceState);</span><br><span class="line">09</span><br><span class="line">       setContentView(R.layout.main);</span><br><span class="line">10</span><br><span class="line">    &#125;</span><br><span class="line">11</span><br><span class="line"></span><br><span class="line">12</span><br><span class="line">    public void btnClick(View v)&#123;</span><br><span class="line">13</span><br><span class="line">       textView.setText(&quot;text set form button&quot;);</span><br><span class="line">14</span><br><span class="line">    &#125;</span><br><span class="line">15</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FinalHttp使用方法：</p>
<p>普通get方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">01</span><br><span class="line">FinalHttp fh = new FinalHttp();</span><br><span class="line">02</span><br><span class="line">fh.get(&quot;http://www.yangfuhai.com&quot;, new AjaxCallBack()&#123;</span><br><span class="line">03</span><br><span class="line"></span><br><span class="line">04</span><br><span class="line">    @Override</span><br><span class="line">05</span><br><span class="line">    public void onLoading(long count, long current) &#123; //每1秒钟自动被回调一次</span><br><span class="line">06</span><br><span class="line">            textView.setText(current+&quot;/&quot;+count);</span><br><span class="line">07</span><br><span class="line">    &#125;</span><br><span class="line">08</span><br><span class="line"></span><br><span class="line">09</span><br><span class="line">    @Override</span><br><span class="line">10</span><br><span class="line">    public void onSuccess(String t) &#123;</span><br><span class="line">11</span><br><span class="line">            textView.setText(t==null?&quot;null&quot;:t);</span><br><span class="line">12</span><br><span class="line">    &#125;</span><br><span class="line">13</span><br><span class="line"></span><br><span class="line">14</span><br><span class="line">    @Override</span><br><span class="line">15</span><br><span class="line">    public void onStart() &#123;</span><br><span class="line">16</span><br><span class="line">        //开始http请求的时候回调</span><br><span class="line">17</span><br><span class="line">    &#125;</span><br><span class="line">18</span><br><span class="line"></span><br><span class="line">19</span><br><span class="line">    @Override</span><br><span class="line">20</span><br><span class="line">    public void onFailure(Throwable t, String strMsg) &#123;</span><br><span class="line">21</span><br><span class="line">        //加载失败的时候回调</span><br><span class="line">22</span><br><span class="line">    &#125;</span><br><span class="line">23</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>使用FinalHttp上传文件 或者 提交数据 到服务器（post方法）</p>
<p>文件上传到服务器，服务器如何接收，请查看这里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">01</span><br><span class="line">AjaxParams params = new AjaxParams();</span><br><span class="line">02</span><br><span class="line">  params.put(&quot;username&quot;, &quot;michael yang&quot;);</span><br><span class="line">03</span><br><span class="line">  params.put(&quot;password&quot;, &quot;123456&quot;);</span><br><span class="line">04</span><br><span class="line">  params.put(&quot;email&quot;, &quot;test@tsz.net&quot;);</span><br><span class="line">05</span><br><span class="line">  params.put(&quot;profile_picture&quot;, new File(&quot;/mnt/sdcard/pic.jpg&quot;)); // 上传文件</span><br><span class="line">06</span><br><span class="line">  params.put(&quot;profile_picture2&quot;, inputStream); // 上传数据流</span><br><span class="line">07</span><br><span class="line">  params.put(&quot;profile_picture3&quot;, new ByteArrayInputStream(bytes)); // 提交字节流</span><br><span class="line">08</span><br><span class="line"></span><br><span class="line">09</span><br><span class="line">  FinalHttp fh = new FinalHttp();</span><br><span class="line">10</span><br><span class="line">  fh.post(&quot;http://www.yangfuhai.com&quot;, params, new AjaxCallBack()&#123;</span><br><span class="line">11</span><br><span class="line">        @Override</span><br><span class="line">12</span><br><span class="line">        public void onLoading(long count, long current) &#123;</span><br><span class="line">13</span><br><span class="line">                textView.setText(current+&quot;/&quot;+count);</span><br><span class="line">14</span><br><span class="line">        &#125;</span><br><span class="line">15</span><br><span class="line"></span><br><span class="line">16</span><br><span class="line">        @Override</span><br><span class="line">17</span><br><span class="line">        public void onSuccess(String t) &#123;</span><br><span class="line">18</span><br><span class="line">            textView.setText(t==null?&quot;null&quot;:t);</span><br><span class="line">19</span><br><span class="line">        &#125;</span><br><span class="line">20</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>使用FinalHttp下载文件：</p>
<p>支持断点续传，随时停止下载任务 或者 开始任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">01</span><br><span class="line">FinalHttp fh = newFinalHttp(); </span><br><span class="line">02</span><br><span class="line">    //调用download方法开始下载</span><br><span class="line">03</span><br><span class="line">    HttpHandler handler = fh.download(&quot;http://www.xxx.com/下载路径/xxx.apk&quot;, //这里是下载的路径</span><br><span class="line">04</span><br><span class="line">    true,//true:断点续传 false:不断点续传（全新下载）</span><br><span class="line">05</span><br><span class="line">    &quot;/mnt/sdcard/testapk.apk&quot;, //这是保存到本地的路径</span><br><span class="line">06</span><br><span class="line">    newAjaxCallBack() &#123; </span><br><span class="line">07</span><br><span class="line">                @Override </span><br><span class="line">08</span><br><span class="line">                public void onLoading(long count, longcurrent) &#123; </span><br><span class="line">09</span><br><span class="line">                     textView.setText(&quot;下载进度：&quot;+current+&quot;/&quot;+count); </span><br><span class="line">10</span><br><span class="line">                &#125; </span><br><span class="line">11</span><br><span class="line"></span><br><span class="line">12</span><br><span class="line">                @Override </span><br><span class="line">13</span><br><span class="line">                public voidonSuccess(File t) &#123; </span><br><span class="line">14</span><br><span class="line">                    textView.setText(t==null?&quot;null&quot;:t.getAbsoluteFile().toString()); </span><br><span class="line">15</span><br><span class="line">                &#125; </span><br><span class="line">16</span><br><span class="line"></span><br><span class="line">17</span><br><span class="line">            &#125;); </span><br><span class="line">18</span><br><span class="line"></span><br><span class="line">19</span><br><span class="line"></span><br><span class="line">20</span><br><span class="line">   //调用stop()方法停止下载</span><br><span class="line">21</span><br><span class="line">   handler.stop();</span><br></pre></td></tr></table></figure>
<p>FinalBitmap 使用方法</p>
<p>加载网络图片就一行代码 fb.display(imageView,url) ,更多的display重载请看帮助文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">view sourceprint?</span><br><span class="line">01</span><br><span class="line">private GridView gridView;</span><br><span class="line">02</span><br><span class="line">    private FinalBitmap fb;</span><br><span class="line">03</span><br><span class="line">    @Override</span><br><span class="line">04</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">05</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">06</span><br><span class="line">        setContentView(R.layout.images);</span><br><span class="line">07</span><br><span class="line"></span><br><span class="line">08</span><br><span class="line">        gridView = (GridView) findViewById(R.id.gridView);</span><br><span class="line">09</span><br><span class="line">        gridView.setAdapter(mAdapter);</span><br><span class="line">10</span><br><span class="line"></span><br><span class="line">11</span><br><span class="line">        fb = FinalBitmap.create(this);//初始化FinalBitmap模块</span><br><span class="line">12</span><br><span class="line">        fb.configLoadingImage(R.drawable.downloading);</span><br><span class="line">13</span><br><span class="line">        //这里可以进行其他十几项的配置，也可以不用配置，配置之后必须调用init()函数,才生效</span><br><span class="line">14</span><br><span class="line">        //fb.configBitmapLoadThreadSize(int size)</span><br><span class="line">15</span><br><span class="line">        //fb.configBitmapMaxHeight(bitmapHeight)</span><br><span class="line">16</span><br><span class="line">    &#125;</span><br><span class="line">17</span><br><span class="line"></span><br><span class="line">18</span><br><span class="line"></span><br><span class="line">19</span><br><span class="line">///////////////////////////adapter getView////////////////////////////////////////////</span><br><span class="line">20</span><br><span class="line"></span><br><span class="line">21</span><br><span class="line">public View getView(int position, View convertView, ViewGroup parent) &#123;</span><br><span class="line">22</span><br><span class="line">    ImageView iv;</span><br><span class="line">23</span><br><span class="line">    if(convertView == null)&#123;</span><br><span class="line">24</span><br><span class="line">        convertView = View.inflate(BitmapCacheActivity.this,R.layout.image_item, null);</span><br><span class="line">25</span><br><span class="line">        iv = (ImageView) convertView.findViewById(R.id.imageView);</span><br><span class="line">26</span><br><span class="line">        iv.setScaleType(ScaleType.CENTER_CROP);</span><br><span class="line">27</span><br><span class="line">        convertView.setTag(iv);</span><br><span class="line">28</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">29</span><br><span class="line">        iv = (ImageView) convertView.getTag();</span><br><span class="line">30</span><br><span class="line">    &#125;</span><br><span class="line">31</span><br><span class="line">    //bitmap加载就这一行代码，display还有其他重载，详情查看源码</span><br><span class="line">32</span><br><span class="line">    fb.display(iv,Images.imageUrls[position]);</span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2016/05/14/Android_Afinal框架/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-05-14 </div>
			<div class="article-title"><a href="/2016/05/14/Android_消息推送/" >Android 消息推送</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>1.引言</p>
<p>　　所谓的消息推送就是从服务器端向移动终端发送连接，传输一定的信息。比如一些新闻客户端，每隔一段时间收到一条或者多条通知，这就是从服务器端传来的推送消息；还比如常用的一些IM软件如微信、GTalk等，都具有服务器推送功能。</p>
<p>　　推送方法如下：</p>
<p>　　1)通过SMS进行服务器端和客户端的交流通信。</p>
<p>　　在Android平台上，你可以通过拦截SMS消息并且解析消息内容来了解服务器的意图，可以实现完全的实时操作。但是问题是这个方案的成本相对比较高，且依赖于运营商。</p>
<p>　　2)循环主动定时获取</p>
<p>　　这种方法需要客户端来做一个定时或者周期性的访问服务器端接口，以获得最新的消息。轮询的频率太慢可能导致某些消息的延迟，太快则会大量消耗网络带宽和电池。</p>
<p>　　3)持久连接</p>
<p>　　这个方案可以解决由轮询带来的性能问题，但是还是会消耗手机的电池。我们需要开一个服务来保持和服务器端的持久连接（苹果就和谷歌的C2DM是这种机制）。但是对于Android系统，当系统可用资源较低，系统会强制关闭我们的服务或者是应用，这种情况下连接会强制中断。（Apple的推送服务之所以工作的很好，是因为每一台手机仅仅保持一个与服务器之间的连接，事实上C2DM也是这么工作的。即所有的推送服务都是经由一个代理服务器完成的，这种情况下只需要和一台服务器保持持久连接即可。C2DM=Cloud to Device Messaging）。</p>
<p>　　相比之下第三种还是最可行的。为软件编写系统服务或开机启动功能；或者如果系统资源较低，服务被关闭后可以在onDestroy ()方法里面再重启该服务，进而实现持久连接的方式。</p>
<p>　　C2DM内置于Android的2.2系统上，无法兼容老的1.6到2.1系统；且依赖于Google官方提供的C2DM服务器，由于国内的网络环境，这个服务经常不可用。</p>
<p>　　建立在TCP协议之上的XMPP协议，不仅可提供可这种持久连接的功能，能实现服务器和客户机的双工通信，还能不依赖与系统版本和google服务器的限制，提供了比较好的解决方案。</p>
<ol>
<li>XMPP协议</li>
</ol>
<p>　　XMPP全称Extensible Messaging and Presence Protocol，前身是Jabber项目，是一种以XML为基础的开放式即时通讯协议。XMPP因为被Google Talk和网易泡泡应用而被广大网民所接触。XMPP的关键特色是，分散式的即时通讯系统，以及使用XML串流。XMPP目前被IETF国际标准组织完成了标准化工作。</p>
<p>　　Android push notification(androidpn) 是一个基于XMPP协议的java开源实现，它包含了完整的客户端和服务器端。该服务器端基本是在另外一个开源工程openfire基础上修改实现的。</p>
<p>　　androidpn客户端需要用到一个基于java的开源XMPP协议包asmack，这个包同样也是基于openfire下的另外一个开源项目smack，不过我们不需要自己编译，可以直接把androidpn客户端里面的asmack.jar拿来使用。客户端利用asmack中提供的XMPPConnection类与服务器建立持久连接，并通过该连接进行用户注册和登录认证，同样也是通过这条连接，接收服务器发送的通知。</p>
<p>　　androidpn服务器端也是java语言实现的，基于openfire开源工程，不过它的Web部分采用的是spring框架，这一点与openfire是不同的。Androidpn服务器包含两个部分，一个是侦听在5222端口上的XMPP服务，负责与客户端的XMPPConnection类进行通信，作用是用户注册和身份认证，并发送推送通知消息。另外一部分是Web服务器，采用一个轻量级的HTTP服务器，负责接收用户的Web请求。服务器的这两方式，意义非凡：当相应的TCP端口被防火墙封闭，可以使用轮询的方式进行访问，因此又有助于通过防火墙。</p>

	
	</div>
  <a type="button" href="/2016/05/14/Android_消息推送/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-05-14 </div>
			<div class="article-title"><a href="/2016/05/14/Json_反序列化/" >Json反序列化</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<pre><code>  /**
 * 由字符串反序列化成实体类  针对的是一个实体，此实体中的属性不包括自定义的类型，如Teacher类型，或者List&lt;Teacher&gt;类型 
 * @param source 传入json中的字符串
 * @param beanClass 实体类的类型
 * @return 实体类
 */
public static Object getObjFromJsonArrStr(String source,Class beanClass)
{
    JSONObject jsonObject = (JSONObject) JSONSerializer.toJSON(source);
    return  JSONObject.toBean(jsonObject,beanClass);       
}
/**
 * 由字符串反序列化成实体类  针对的是一个实体，此实体中的属性包括自定义的类型，如Teacher类型，或者List&lt;Teacher&gt;类型
 * @param jsonArrStr
 * @param clazz
 * @param classMap
 * @return
 */
public static Object getObjFromJsonArrStr(String jsonArrStr, Class clazz, Map classMap) 
{ 
    JSONObject jsonObj = JSONObject.fromObject(jsonArrStr);  
            return JSONObject.toBean(jsonObj, clazz, classMap);            
}


/**
 * 将string转换成listBean
 * @param jsonArrStr 需要反序列化的字符串
 * @param clazz 被反序列化之后的类
 * @return 实体list
 */
@SuppressWarnings(&quot;unchecked&quot;)
public static List getListFromJsonArrStr(String jsonArrStr, Class clazz) {  
    JSONArray jsonArr = JSONArray.fromObject(jsonArrStr);  
    List list = new ArrayList(); 
    for (int i = 0; i &lt; jsonArr.size(); i++) 
    { 
        list.add(JSONObject.toBean(jsonArr.getJSONObject(i), clazz));  
    } 
    return list; 
}

/**
 * 将string转换成listBean 属性中包含实体类等 如List&lt;Student&gt; 而Student中含有属性List&lt;Teacher&gt;
 * @param jsonArrStr 需要反序列化的字符串
 * @param clazz 反序列化后的类
 * @param classMap 将属性中包含的如Teacher加入到一个Map中，格式如map.put(&quot;teacher&quot;,Teacher.class)
 * @return 反序列化后的字符串
 * 使用示例：
    Map classMap = new HashMap();
    //必须要对Parent进行初始化 否则不识别
    Teacher p = new Teacher();
    classMap.put(&quot;teacher&quot;, p.getClass());
    List mlist = JSONTransfer.getListFromJsonArrStr(resultStr, Student.class, classMap);
 */
@SuppressWarnings(&quot;unchecked&quot;)
public static List getListFromJsonArrStr(String jsonArrStr, Class clazz, Map classMap) 
{ 
   JSONArray jsonArr = JSONArray.fromObject(jsonArrStr);  
   List list = new ArrayList(); 
   for (int i = 0; i &lt; jsonArr.size(); i++) 
   {          
       list.add(JSONObject.toBean(jsonArr.getJSONObject(i), clazz, classMap));  
   } 
   return list; 
}

/**
 * 序列化操作，无论是单个的对象，还是list，抑或是list中的属性仍包含list，都可以直接序列化成String类型
 * @param obj 需要被序列化的对象
 * @return 序列化之后的字符串
 */
@SuppressWarnings(&quot;unchecked&quot;)
public static String getJsonArrStrFromList(Object obj) 
{
    //返回結果
    String jsonStr = null; 
    //判空
    if (obj == null) {  
        return &quot;{}&quot;; 
    } 
    //Json配置     
    JsonConfig jsonCfg = new JsonConfig(); 

    //注册日期处理器 
    jsonCfg.registerJsonValueProcessor(java.util.Date.class, 
            new JsonDateValueProcessor(SystemConstants.DateFormat)); 

    //判断是否是list
    if (objinstanceof Collection || obj instanceof Object[]) {  
        jsonStr = JSONArray.fromObject(obj, jsonCfg).toString();  
    }else { 
        jsonStr = JSONObject.fromObject(obj, jsonCfg).toString();  
    }    
    return jsonStr;
}
</code></pre><p>关于Java序列化，ITEye上有一篇讨论的帖子比较好</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;http://www.iteye.com/topic/14707&quot;&gt;http://www.iteye.com/topic/14707&lt;/a&gt;</span><br></pre></td></tr></table></figure>
	
	</div>
  <a type="button" href="/2016/05/14/Json_反序列化/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-05-14 </div>
			<div class="article-title"><a href="/2016/05/14/Android_检查是否联网/" >Android_检查是否联网</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>检查是否联网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public static boolean isNetworkAvailable(Activity mActivity) &#123;</span><br><span class="line"> Context context = mActivity.getApplicationContext();</span><br><span class="line"> ConnectivityManager connectivity = (ConnectivityManager) context</span><br><span class="line">   .getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line"> if (connectivity == null) &#123;</span><br><span class="line">  return false;</span><br><span class="line"> &#125; else &#123;</span><br><span class="line">  NetworkInfo[] info = connectivity.getAllNetworkInfo();</span><br><span class="line">  if (info != null) &#123;</span><br><span class="line">   for (int i = 0; i &lt; info.length; i++) &#123;</span><br><span class="line">    if (info[i].getState() == NetworkInfo.State.CONNECTED) &#123;</span><br><span class="line">     return true;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void HttpTest(final Activity mActivity) &#123;</span><br><span class="line"> if (!isNetworkAvailable(mActivity)) &#123;</span><br><span class="line">  showToast(mActivity);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void showToast(Activity mActivity) &#123;</span><br><span class="line"> Vibrator mVibrator01 = (Vibrator) mActivity.getApplication()</span><br><span class="line">   .getSystemService(Service.VIBRATOR_SERVICE);</span><br><span class="line"> mVibrator01.vibrate(new long[] &#123; 100, 10, 100, 1000 &#125;, -1);</span><br><span class="line"> Toast.makeText(mActivity, &quot;请检查是否联网&quot;, 500).show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中还要加上手机震动和联网的权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot;/&gt; </span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.VIBRATE&quot;/&gt;</span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2016/05/14/Android_检查是否联网/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-05-14 </div>
			<div class="article-title"><a href="/2016/05/14/Android-应用插件式开发解决方法/" >Android 应用插件式开发解决方法</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>Android应用插件式开发解决方法</p>
<p>一、现实需求描述</p>
<p>一般的，一个Android应用在开发到了一定阶段以后，功能模块将会越来越多，APK安装包也越来越大，用户在使用过程中也没有办法选择性的加载自己需要的功能模块。此时可能就需要考虑如何分拆整个应用了。<br>二、解决方案提出</p>
<p>一般有两种方式，一种是将应用按照功能分拆成多个应用，用户需要哪个就下载哪个，都需要就都下载。应用之间，可以在代码层面做一定的关联，以共享部分信息。另一种方式，类似于其他平台插件的方式，用户可以在主应用中可以选择性的下载需要的插件，不需要该功能，则不需要下载。<br>第一种方式，只需要开发多个应用就够了。第二种方式稍微复杂，需要做很多额外的工作。这里我们简单讨论第二种方式的大致实现方法。<br>三、实现方法概述</p>
<p>有人可能会想到，是否可以像其他平台那样，下载一个类似于dll文件，或者jar包，就能自动识别并且加载该功能？可惜的是，在Android平台上是不允许直接动态加载jar包的，作者也没有想到类似办法。所以，想实现这种功能，还是要以独立APK的方式来加载。和第一种方式不同的是，从设计的角度，具体的插件是没有独立运行的入口的，也不允许有桌面图标存在，必须从主应用中打开，关闭后回到主应用（插件既然是APK，它安装完怎么会没有入口？怎么会没有桌面图标？QQ的跑酷等游戏不就是插件？不是就有图标入口？）。从用户的角度看，可以在应用中加载需要的功能并且使用，也就类似于其他平台插件的方式了。<br>为了实现这种方式，从设计的角度，就需要考虑清楚哪些功能作为独立的插件提供给用户，这里不再详述。下面从开发的角度说明大致需要做的工作。<br>Ø  主应用中需要开发的框架功能：<br>识别具体的插件是否已经安装（根据插件的package名）<br>如果已经安装要判断是否需要升级（服务器端获取最新的版本和本地的比较）<br>下载并且安装（或者升级）插件<br>卸载该插件<br>Ø  插件APK开发中需要注意的事项：<br>Manifest文件中不要提供启动的入口<br>Ø  主应用和插件之间交互的提示：<br>最好是使用相同的android:sharedUserId，插件可以方便的获取主应用的资源、数据库等等。<br>主应用可以以Intent方式启动具体的插件，同时带入Map类型参数或者json串参数，在插件APK中解析具体参数，实现业务逻辑。<br>三、其他说明</p>
<p>本博客内容并没有具体说明如何去实现，没有代码级别的说明。但是通过上面介绍的方式，开发者基本已经可以理解如何实现插件式的Android应用了。具体的，在开发过程中可能还会遇到很多问题，需要开发者自己摸索和完善。</p>
<p>///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////<br>框架已经放出：<br>Logo<br>android-application-plug-ins-frame-work<br>安卓应用程序插件化开发框架 -AAP Framework</p>
<pre><code>在android的项目开发中，都会遇到后期功能拓展增强与主程序代码变更的现实矛盾，也就是程序的灵活度。
由于linux平台的安全机制，再加上dalvik的特殊机制，各种权限壁垒，使得开发一个灵活多变的程序，变得比较困难，不像pc平台下那么容易。
瞅瞅elipse的插件，瞅瞅360的插件，在android下，我们一开始很难写好一个主程序，然后通过插件机制来应对以后的功能拓展，于是程序变得不那么灵活多变了。
比如一款android下的安全软件，新版本增加了一个功能，如短信拦截，往往会因为一个模块的增加，而重新编译一个apk包，这样周而复始，哪怕只增加50kb的功能代码，用户也需要升级一个完整的apk，往往是5~6M的体积。

最近思来想去，想到一个方法，既然tencent qq在android下面可以以apk的形式来换皮肤，这资源文件的拓展都可以这样简便的搞，为何功能性的拓展就不可以？
</code></pre><p>想出来了两种解决方案。<br>先来说说第一种。</p>
<p>demo下载在最后</p>
<p>先说分析思路。<br>     android下，默认的情况是，每个apk相互独立的，基本上每个应用都是一个dalvik虚拟机，都有一个uid，再配合上linux本身的权限机制，使得apk互通很难直接进行。但作为一个独立应用的集成，不管多少个apk，都可以并为一个单独的dalvik虚拟机，直观的反映给开发人员就是在shell下列出进程，那几个apk同时加载后，会一个进程存在。<br>     这主要就是工程的清单文件 Mainfest中配置了，只需要一句话，以我的测试demo为例：<br>复制代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">      package=&quot;org.igeek.plugintest.main&quot;</span><br><span class="line">      &lt;!-- 就是这句关键代码 --&gt;</span><br><span class="line">      android:sharedUserId=&quot;org.igeek.plugintest&quot;</span><br><span class="line">      android:versionCode=&quot;1&quot;      </span><br><span class="line">      android:versionName=&quot;1.0&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>复制代码</p>
<pre><code>在上面的代码中，android:sharedUserId是指共用一个uid，也就是，凡是这个属性相同的工程，都会共用同一个uid，这样，权限壁垒就消除了，dalvik也会融合为一个，可以测试一下，写几个工程，没有这个属性和有这个属性的情况下，同时运行，在列出当前进程，就直观的说明了。
</code></pre><p>   程序拓展的插件化，当然需要一个主程序，主程序是实现基本功能，以及UI，还有插件的检索以及插件的调用。<br>   这里贴出我demo中的主activity代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">复制代码</span><br><span class="line">  1 public class AndoirdpluginActivity extends ActivityGroup implements OnClickListener ,OnScrollCompleteListener&#123;</span><br><span class="line">  2     private LinearLayout llMainLayout;</span><br><span class="line">  3     </span><br><span class="line">  4     //workspace，看看luncher的源码，这个就是桌面那个多屏的实现</span><br><span class="line">  5     private WorkSpace wkMain;</span><br><span class="line">  6     private Button btnFindPlugins;</span><br><span class="line">  7     private CheckBox chbAttachMain;</span><br><span class="line">  8     </span><br><span class="line">  9     private LocalActivityManager m_ActivityManager;</span><br><span class="line"> 10     </span><br><span class="line"> 11     //这个bean的集合，就相当于插件的描述集合</span><br><span class="line"> 12 //每个bean也就是一个插件的各种描述</span><br><span class="line"> 13     private List&lt;PluginBean&gt; plugins;</span><br><span class="line"> 14     </span><br><span class="line"> 15     @Override</span><br><span class="line"> 16     public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line"> 17         super.onCreate(savedInstanceState);</span><br><span class="line"> 18         setContentView(R.layout.main);</span><br><span class="line"> 19         </span><br><span class="line"> 20         llMainLayout=(LinearLayout) findViewById(R.id.main_llMainLayout);</span><br><span class="line"> 21         wkMain=(WorkSpace) findViewById(R.id.main_wkMain);</span><br><span class="line"> 22         btnFindPlugins=(Button) findViewById(R.id.main_btnFindPlugins);</span><br><span class="line"> 23         chbAttachMain=(CheckBox) findViewById(R.id.main_chbAttachMain);</span><br><span class="line"> 24         </span><br><span class="line"> 25         m_ActivityManager = getLocalActivityManager();</span><br><span class="line"> 26         </span><br><span class="line"> 27         wkMain.setOnScrollCompleteLinstenner(this);</span><br><span class="line"> 28         btnFindPlugins.setOnClickListener(this);</span><br><span class="line"> 29     &#125;</span><br><span class="line"> 30 </span><br><span class="line"> 31     @Override</span><br><span class="line"> 32     public void onClick(View v) &#123;</span><br><span class="line"> 33         attachPlugin(findPlugins());</span><br><span class="line"> 34         btnFindPlugins.setVisibility(View.GONE);</span><br><span class="line"> 35     &#125;</span><br><span class="line"> 36     </span><br><span class="line"> 37     /**</span><br><span class="line"> 38      * 加载插件列表</span><br><span class="line"> 39      * @param plugins</span><br><span class="line"> 40 */</span><br><span class="line"> 41     private void attachPlugin(final List&lt;PluginBean&gt; plugins)&#123;</span><br><span class="line"> 42         Log.e(&quot;ydt&quot;, &quot;   &quot;);</span><br><span class="line"> 43         Log.e(&quot;ydt&quot;, &quot;----- 列出插件&quot;);</span><br><span class="line"> 44         this.plugins=plugins;</span><br><span class="line"> 45         for(final PluginBean plugin:plugins)&#123;</span><br><span class="line"> 46             Button btn=new Button(this);</span><br><span class="line"> 47             btn.setTextColor(Color.RED);</span><br><span class="line"> 48             btn.setText(plugin.getLabel());</span><br><span class="line"> 49             </span><br><span class="line"> 50             llMainLayout.addView(btn);</span><br><span class="line"> 51             //添加事件</span><br><span class="line"> 52             btn.setOnClickListener(new OnClickListener() &#123;</span><br><span class="line"> 53                 </span><br><span class="line"> 54                 @Override</span><br><span class="line"> 55                 public void onClick(View v) &#123;</span><br><span class="line"> 56                     boolean isAttack=chbAttachMain.isChecked();</span><br><span class="line"> 57                     </span><br><span class="line"> 58                     Intent it=new Intent();</span><br><span class="line"> 59                     it.setAction(plugin.getPakageName());</span><br><span class="line"> 60                     </span><br><span class="line"> 61                     //是否附加为view</span><br><span class="line"> 62                     if(isAttack)&#123;</span><br><span class="line"> 63                         //这里偷下懒，这是演示插件作为view附加到主程序中的</span><br><span class="line"> 64                         for(PluginBean plugin:plugins)&#123;</span><br><span class="line"> 65                             </span><br><span class="line"> 66                             Intent itt=new Intent();</span><br><span class="line"> 67                             itt.setAction(plugin.getPakageName());</span><br><span class="line"> 68                             ViewGroup view=(ViewGroup) (m_ActivityManager.startActivity(&quot;&quot;, itt)).getDecorView();</span><br><span class="line"> 69                             wkMain.addView(view);</span><br><span class="line"> 70                         &#125;</span><br><span class="line"> 71                         //一次性附加完毕算了，然后把按钮都删了，看着清净，这几个不是重点</span><br><span class="line"> 72                         llMainLayout.removeAllViews();</span><br><span class="line"> 73                         chbAttachMain.setVisibility(View.GONE);</span><br><span class="line"> 74                         wkMain.setToScreen(0);</span><br><span class="line"> 75                     &#125;else&#123;</span><br><span class="line"> 76                         //这里，不会把插件的窗体附加到主程序中，纯粹无用的演示</span><br><span class="line"> 77                         startActivity(it);</span><br><span class="line"> 78                     &#125;</span><br><span class="line"> 79                 &#125;</span><br><span class="line"> 80             &#125;);</span><br><span class="line"> 81             </span><br><span class="line"> 82         &#125;</span><br><span class="line"> 83     &#125;</span><br><span class="line"> 84     </span><br><span class="line"> 85     /**</span><br><span class="line"> 86      * 查找插件</span><br><span class="line"> 87      * @return</span><br><span class="line"> 88 */</span><br><span class="line"> 89     private List&lt;PluginBean&gt; findPlugins()&#123;</span><br><span class="line"> 90         </span><br><span class="line"> 91         List&lt;PluginBean&gt; plugins=new ArrayList&lt;PluginBean&gt;();</span><br><span class="line"> 92         </span><br><span class="line"> 93         </span><br><span class="line"> 94         //遍历包名，来获取插件</span><br><span class="line"> 95         PackageManager pm=getPackageManager();</span><br><span class="line"> 96         </span><br><span class="line"> 97         </span><br><span class="line"> 98         List&lt;PackageInfo&gt; pkgs=pm.getInstalledPackages(PackageManager.GET_UNINSTALLED_PACKAGES);</span><br><span class="line"> 99         for(PackageInfo pkg    :pkgs)&#123;</span><br><span class="line">100             //包名</span><br><span class="line">101             String packageName=pkg.packageName;</span><br><span class="line">102             String sharedUserId= pkg.sharedUserId;</span><br><span class="line">103             </span><br><span class="line">104             //sharedUserId是开发时约定好的，这样判断是否为自己人</span><br><span class="line">105             if(!&quot;org.igeek.plugintest&quot;.equals(sharedUserId)||&quot;org.igeek.plugintest.main&quot;.equals(packageName))</span><br><span class="line">106                 continue;</span><br><span class="line">107             </span><br><span class="line">108             //进程名</span><br><span class="line">109             String prcessName=pkg.applicationInfo.processName;</span><br><span class="line">110             </span><br><span class="line">111             //label，也就是appName了</span><br><span class="line">112             String label=pm.getApplicationLabel(pkg.applicationInfo).toString();</span><br><span class="line">113             </span><br><span class="line">114             PluginBean plug=new PluginBean();</span><br><span class="line">115             plug.setLabel(label);</span><br><span class="line">116             plug.setPakageName(packageName);</span><br><span class="line">117             </span><br><span class="line">118             plugins.add(plug);</span><br><span class="line">119         &#125;</span><br><span class="line">120         </span><br><span class="line">121         </span><br><span class="line">122         return plugins;</span><br><span class="line">123         </span><br><span class="line">124     &#125;</span><br><span class="line">125 </span><br><span class="line">126  </span><br><span class="line">127     /**</span><br><span class="line">128      * WorkSpace滚动到那个屏，会触发这个事件</span><br><span class="line">129      * 而worksapce中每一屏又是一个插件</span><br><span class="line">130      * 这个事件是用来列出当前屏幕插件所提供的应用，并且让用户调用</span><br><span class="line">131 */</span><br><span class="line">132     @Override</span><br><span class="line">133     public void onScrollComplete(final ScrollEvent e) &#123;</span><br><span class="line">134         try &#123;</span><br><span class="line">135             final Context context = createPackageContext(plugins.get(e.curScreen).getPakageName(), Context.CONTEXT_INCLUDE_CODE|Context.CONTEXT_IGNORE_SECURITY);</span><br><span class="line">136             llMainLayout.removeAllViews();</span><br><span class="line">137             //这几行，通过反射获取了当前插件的描述信息，如同大部分框架的xml一样，这里算是模拟了一下IOC控制反转</span><br><span class="line">138             Class clazz=context.getClassLoader().loadClass(plugins.get(e.curScreen).getPakageName()+&quot;.PluginApplication&quot;);</span><br><span class="line">139             Object o=clazz.newInstance();</span><br><span class="line">140             Map&lt;String,List&lt;String&gt;&gt;  r=(Map&lt;String, List&lt;String&gt;&gt;) clazz.getMethod(&quot;getDesciption&quot;).invoke(o);</span><br><span class="line">141             List&lt;String&gt; classes=r.get(&quot;classes&quot;);</span><br><span class="line">142             List&lt;String&gt; methods=r.get(&quot;methods&quot;);</span><br><span class="line">143             </span><br><span class="line">144             </span><br><span class="line">145             //这里，根据获得的插件所提供的功能，来生成几个按钮显示，供我们调用</span><br><span class="line">146             for(final String clas:classes)&#123;</span><br><span class="line">147                 for(final String method:methods)&#123;</span><br><span class="line">148                     Button btn=new Button(this);</span><br><span class="line">149                     </span><br><span class="line">150                     btn.setText(clas+&quot; -&gt; &quot;+method+&quot; 执行&quot;);</span><br><span class="line">151                     </span><br><span class="line">152                     </span><br><span class="line">153                     //点击后，就执行插件所提供的方法</span><br><span class="line">154                     btn.setOnClickListener(new OnClickListener() &#123;</span><br><span class="line">155                         </span><br><span class="line">156                         @Override</span><br><span class="line">157                         public void onClick(View v) &#123;</span><br><span class="line">158                             try &#123;</span><br><span class="line">159                                 Class c=context.getClassLoader().loadClass(plugins.get(e.curScreen).getPakageName()+&quot;.&quot;+clas);</span><br><span class="line">160                                 Object o1=c.newInstance();</span><br><span class="line">161                                 </span><br><span class="line">162                                 //这里注意，context实际上就是句柄，这里如果涉及到窗体，plugin的句柄其实是不行的，因为它没有可以</span><br><span class="line">163 //依附的窗体</span><br><span class="line">164                                 </span><br><span class="line">165 //这个context是plugin的，通过测试，dialog这类行不通,Toast是可以的，因为</span><br><span class="line">166 //Toast是依附于屏幕主窗口的</span><br><span class="line">167 //c.getMethod(method,Context.class).invoke(o1,context); </span><br><span class="line">168                                                         </span><br><span class="line">169 //这里则传递的是主程序的句柄</span><br><span class="line">170                                 c.getMethod(method,Context.class).invoke(o1,AndoirdpluginActivity.this);</span><br><span class="line">171                             </span><br><span class="line">172                             &#125; catch (Exception e) &#123;</span><br><span class="line">173                                 // TODO Auto-generated catch block</span><br><span class="line">174                                 e.printStackTrace();</span><br><span class="line">175                             &#125; </span><br><span class="line">176                         &#125;</span><br><span class="line">177                     &#125;);</span><br><span class="line">178                     llMainLayout.addView(btn);</span><br><span class="line">179                 &#125;</span><br><span class="line">180             &#125;</span><br><span class="line">181             </span><br><span class="line">182         </span><br><span class="line">183         &#125; catch (Exception e1) &#123;</span><br><span class="line">184             // TODO Auto-generated catch block</span><br><span class="line">185             e1.printStackTrace();</span><br><span class="line">186         &#125;</span><br><span class="line">187     </span><br><span class="line">188     &#125;</span><br><span class="line">189 &#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<pre><code>看注释吧，主要有两点
</code></pre><p>插件的扫描<br>        这种方案是，每个插件以一个单独的apk发布，这样可以在程序中很灵活的知道是否有新的插件，提示用户下载安装，插件的apk清单描述为Action为非Luncher，Category为Default。<br>        主程序侦听packgeManager的安装完成广播，之后扫描同包名（插件当然得这么定义了，只要通过packgeManager能判断是否为自己的插件就行）的apk，之后列出来，让用户选择是否加载。</p>
<p>插件的加载与调用<br>         在获取包后，通过调用系统的api可以得到 sharedUserId 与主程序相同的apk的context，也就是句柄，获得了句柄，通过这个context可以得到classloader，之后就简单了，如何知道这个插件提供什么功能？<br>         这个可以用xml描述，比如这个xml是插件apk的一个资源，就像spring这个框架一样。xml中描述了这个插件有哪些类，提供哪些方法，这些方法需要传入什么参数，返回什么类型。我的demo中为了方便，是用接口，每个插件有一个类提供一个相同的方法，来获取一个map集合，获得这个插件的描述。</p>
<pre><code>ok,到这里就知道加载的插件提供什么功能了。

在上面贴出来的代码中，是循环遍历每个插件，并把每个插件提供的功能以Button的方式显示给用户，点击按钮，就执行了插件的功能，执行时，并不是activity转向（这样就无意义了），而是在主程序自身的context句柄中执行，也就是在自身的窗体中执行。
代码中有一段注释，说明，如果插件有用到context时，记得传递进去的是主程序的context，这样窗体才能附加到这个句柄中，如果传递的是插件的context，它没有一个窗体实例，是无法将一些窗体附加进去的，无任何效果。
</code></pre><p>这里只提供思路，有时间的话研究一下，看能不能搞个通用的框架出来。还有另一种方法，不通过apk形式，以后会写出来。<br>      这里有一些待验证的问题，比如插件的权限问题，如果插件需要的一些权限在主程序中没有声明，会是个什么情况，能不能实时申请呢？这个需要高人指点。或者在主程序中把能声明的权限预先声明了也不错。还有就是native层代码的问题，如果插件包含了native层代码，会是个什么情况，这也需要验证。</p>
<p>这是demo下载：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://files.cnblogs.com/hangxin1940/android_plugin_program.rar</span><br></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2016/05/14/Android-应用插件式开发解决方法/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-05-14 </div>
			<div class="article-title"><a href="/2016/05/14/Android-解析json/" >Android 解析json</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>###JSON的定义：<br>       一种轻量级的数据交换格式，具有良好的可读和便于快速编写的特性。业内主流技术为其提供了完整的解决方案（有点类似于正则表达式 ，获得了当今大部分语言的支持），从而可以在不同平台间进行数据交换。JSON采用兼容性很高的文本格式，同时也具备类似于C语言体系的行为。 – Json.org</p>
<p>JSON Vs XML</p>
<p>1.JSON和XML的数据可读性基本相同</p>
<p>2.JSON和XML同样拥有丰富的解析手段</p>
<p>3.JSON相对于XML来讲，数据的体积小</p>
<p>4.JSON与JavaScript的交互更加方便</p>
<p>5.JSON对数据的描述性比XML较差</p>
<p>6.JSON的速度要远远快于XML</p>
<p>android2.3提供的json解析类 </p>
<p>android的json解析部分都在包org.json下，主要有以下几个类：<br>JSONObject：可以看作是一个json对象,这是系统中有关JSON定义的基本单元，其包含一对儿(Key/Value)数值。它对外部(External：   应用toString()方法输出的数值)调用的响应体现为一个标准的字符串（例如：{“JSON”: “Hello, World”}，最外被大括号包裹，其中的Key和Value被冒号”:”分隔）。其对于内部(Internal)行为的操作格式略微，例如：初始化一个JSONObject实例，引用内部的put()方法添加数值：new JSONObject().put(“JSON”, “Hello, World!”)，在Key和Value之间是以逗号”,”分隔。Value的类型包括：Boolean、JSONArray、JSONObject、Number、String或者默认值JSONObject.NULL object 。</p>
<p>JSONStringer：json文本构建类 ，根据官方的解释，这个类可以帮助快速和便捷的创建JSON text。其最大的优点在于可以减少由于 格式的错误导致程序异常，引用这个类可以自动严格按照JSON语法规则（syntax rules）创建JSON text。每个JSONStringer实体只能对应创建一个JSON text。。其最大的优点在于可以减少由于格式的错误导致程序异常，引用这个类可以自动严格按照JSON语法规则（syntax rules）创建JSON text。每个JSONStringer实体只能对应创建一个JSON text。</p>
<p>JSONArray：它代表一组有序的数值。将其转换为String输出(toString)所表现的形式是用方括号包裹，数值以逗号”,”分隔（例如：     [value1,value2,value3]，大家可以亲自利用简短的代码更加直观的了解其格式）。这个类的内部同样具有查询行为，     get()和opt()两种方法都可以通过index索引返回指定的数值，put()方法用来添加或者替换数值。同样这个类的value类型可以包括：Boolean、JSONArray、JSONObject、Number、String或者默认值JSONObject.NULL object。</p>
<p>JSONTokener：json解析类<br>JSONException：json中用到的异常 </p>
<p>JSONObject, JSONArray来构建json文本   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">代码  </span><br><span class="line">// 假设现在要创建这样一个json文本  </span><br><span class="line">//  &#123;  </span><br><span class="line">//      &quot;phone&quot; : [&quot;12345678&quot;, &quot;87654321&quot;], // 数组  </span><br><span class="line">//      &quot;name&quot; : &quot;yuanzhifei89&quot;, // 字符串  </span><br><span class="line">//      &quot;age&quot; : 100, // 数值  </span><br><span class="line">//      &quot;address&quot; : &#123; &quot;country&quot; : &quot;china&quot;, &quot;province&quot; : &quot;jiangsu&quot; &#125;, // 对象  </span><br><span class="line">//      &quot;married&quot; : false // 布尔值  </span><br><span class="line">//  &#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">try &#123;  </span><br><span class="line">    // 首先最外层是&#123;&#125;，是创建一个对象  </span><br><span class="line">    JSONObject person = new JSONObject();  </span><br><span class="line">    // 第一个键phone的值是数组，所以需要创建数组对象  </span><br><span class="line">    JSONArray phone = new JSONArray();  </span><br><span class="line">    phone.put(&quot;12345678&quot;).put(&quot;87654321&quot;);  </span><br><span class="line">    person.put(&quot;phone&quot;, phone);  </span><br><span class="line">  </span><br><span class="line">    person.put(&quot;name&quot;, &quot;yuanzhifei89&quot;);  </span><br><span class="line">    person.put(&quot;age&quot;, 100);  </span><br><span class="line">    // 键address的值是对象，所以又要创建一个对象  </span><br><span class="line">    JSONObject address = new JSONObject();  </span><br><span class="line">    address.put(&quot;country&quot;, &quot;china&quot;);  </span><br><span class="line">    address.put(&quot;province&quot;, &quot;jiangsu&quot;);  </span><br><span class="line">    person.put(&quot;address&quot;, address);    </span><br><span class="line">    person.put(&quot;married&quot;, false);  </span><br><span class="line">&#125; catch (JSONException ex) &#123;  </span><br><span class="line">    // 键为null或使用json不支持的数字格式(NaN, infinities)  </span><br><span class="line">    throw new RuntimeException(ex);  </span><br><span class="line">&#125; </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">getType和optType api的使用   </span><br><span class="line">getType可以将要获取的键的值转换为指定的类型，如果无法转换或没有值则抛出JSONException </span><br><span class="line">optType也是将要获取的键的值转换为指定的类型，无法转换或没有值时返回用户提供或这默认提供的值 </span><br><span class="line">代码  </span><br><span class="line">try &#123;  </span><br><span class="line">    // 所有使用的对象都是用上面创建的对象  </span><br><span class="line">    // 将第一个电话号码转换为数值和将名字转换为数值  </span><br><span class="line">    phone.getLong(0);  </span><br><span class="line">    person.getLong(&quot;name&quot;); // 会抛异常，因为名字无法转换为long        </span><br><span class="line">    phone.optLong(0); // 代码内置的默认值  </span><br><span class="line">    phone.optLong(0, 1000); // 用户提供的默认值  </span><br><span class="line">    person.optLong(&quot;name&quot;);  </span><br><span class="line">    person.optLong(&quot;name&quot;, 1000); // 不像上面那样抛异常，而是返回1000  </span><br><span class="line">&#125; catch (JSONException ex) &#123;  </span><br><span class="line">    // 异常处理代码  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">除了上面的两个类，还可以使用JSONStringer来构建json文本  </span><br><span class="line"></span><br><span class="line">``` </span><br><span class="line">Java代码  </span><br><span class="line">try &#123;  </span><br><span class="line">    JSONStringer jsonText = new JSONStringer();  </span><br><span class="line">    // 首先是&#123;，对象开始。object和endObject必须配对使用  </span><br><span class="line">    jsonText.object();  </span><br><span class="line">      </span><br><span class="line">    jsonText.key(&quot;phone&quot;);  </span><br><span class="line">    // 键phone的值是数组。array和endArray必须配对使用  </span><br><span class="line">    jsonText.array();  </span><br><span class="line">    jsonText.value(&quot;12345678&quot;).value(&quot;87654321&quot;);  </span><br><span class="line">    jsonText.endArray();  </span><br><span class="line">      </span><br><span class="line">    jsonText.key(&quot;name&quot;);  </span><br><span class="line">    jsonText.value(&quot;yuanzhifei89&quot;);  </span><br><span class="line">    jsonText.key(&quot;age&quot;);  </span><br><span class="line">    jsonText.value(100);  </span><br><span class="line">      </span><br><span class="line">    jsonText.key(&quot;address&quot;);  </span><br><span class="line">    // 键address的值是对象  </span><br><span class="line">    jsonText.object();  </span><br><span class="line">    jsonText.key(&quot;country&quot;);  </span><br><span class="line">    jsonText.value(&quot;china&quot;);  </span><br><span class="line">    jsonText.key(&quot;province&quot;);  </span><br><span class="line">    jsonText.value(&quot;jiangsu&quot;);  </span><br><span class="line">    jsonText.endObject();  </span><br><span class="line">      </span><br><span class="line">    jsonText.key(&quot;married&quot;);  </span><br><span class="line">    jsonText.value(false);  </span><br><span class="line">      </span><br><span class="line">    // &#125;，对象结束  </span><br><span class="line">    jsonText.endObject();  </span><br><span class="line">&#125; catch (JSONException ex) &#123;  </span><br><span class="line">    throw new RuntimeException(ex);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>json文本解析类JSONTokener<br>按照RFC4627规范将json文本解析为相应的对象。  </p>
<p>对于将json文本解析为对象，只需要用到该类的两个api： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">构造函数  </span><br><span class="line">public Object nextValue();  </span><br><span class="line">代码  </span><br><span class="line">//  &#123;  </span><br><span class="line">//      &quot;phone&quot; : [&quot;12345678&quot;, &quot;87654321&quot;], // 数组  </span><br><span class="line">//      &quot;name&quot; : &quot;yuanzhifei89&quot;, // 字符串  </span><br><span class="line">//      &quot;age&quot; : 100, // 数值  </span><br><span class="line">//      &quot;address&quot; : &#123; &quot;country&quot; : &quot;china&quot;, &quot;province&quot; : &quot;jiangsu&quot; &#125;, // 对象  </span><br><span class="line">//      &quot;married&quot; : false // 布尔值  </span><br><span class="line">//  &#125;  </span><br><span class="line">  </span><br><span class="line">private static final String JSON =   </span><br><span class="line">&quot;&#123;&quot; +  </span><br><span class="line">    &quot;   \&quot;phone\&quot; : [\&quot;12345678\&quot;, \&quot;87654321\&quot;],&quot; +  </span><br><span class="line">    &quot;   \&quot;name\&quot; : \&quot;yuanzhifei89\&quot;,&quot; +  </span><br><span class="line">    &quot;   \&quot;age\&quot; : 100,&quot; +  </span><br><span class="line">    &quot;   \&quot;address\&quot; : &#123; \&quot;country\&quot; : \&quot;china\&quot;, \&quot;province\&quot; : \&quot;jiangsu\&quot; &#125;,&quot; +  </span><br><span class="line">    &quot;   \&quot;married\&quot; : false,&quot; +  </span><br><span class="line">&quot;&#125;&quot;;  </span><br><span class="line">  </span><br><span class="line">try &#123;  </span><br><span class="line">    JSONTokener jsonParser = new JSONTokener(JSON);  </span><br><span class="line">    // 此时还未读取任何json文本，直接读取就是一个JSONObject对象。  </span><br><span class="line">    // 如果此时的读取位置在&quot;name&quot; : 了，那么nextValue就是&quot;yuanzhifei89&quot;（String）  </span><br><span class="line">    JSONObject person = (JSONObject) jsonParser.nextValue();  </span><br><span class="line">    // 接下来的就是JSON对象的操作了  </span><br><span class="line">    person.getJSONArray(&quot;phone&quot;);  </span><br><span class="line">    person.getString(&quot;name&quot;);  </span><br><span class="line">    person.getInt(&quot;age&quot;);  </span><br><span class="line">    person.getJSONObject(&quot;address&quot;);  </span><br><span class="line">    person.getBoolean(&quot;married&quot;);  </span><br><span class="line">&#125; catch (JSONException ex) &#123;  </span><br><span class="line">    // 异常处理代码  </span><br><span class="line">&#125;  </span><br><span class="line">其它的api基本就是用来查看json文本中的文本的 </span><br><span class="line"></span><br><span class="line">代码  </span><br><span class="line">try &#123;  </span><br><span class="line">    JSONTokener jsonParser = new JSONTokener(JSON);  </span><br><span class="line">    // 继续向下读8个json文本中的字符。此时刚开始，即在&#123;处  </span><br><span class="line">    jsonParser.next(8); //&#123;    &quot;phone。tab算一个字符  </span><br><span class="line">      </span><br><span class="line">    // 继续向下读1个json文本中的字符  </span><br><span class="line">    jsonParser.next(); //&quot;  </span><br><span class="line">      </span><br><span class="line">    // 继续向下读取一个json文本中的字符。该字符不是空白、同时也不是注视中的字符  </span><br><span class="line">    jsonParser.nextClean(); //:  </span><br><span class="line">      </span><br><span class="line">    // 返回当前的读取位置到第一次遇到&apos;a&apos;之间的字符串（不包括a）。  </span><br><span class="line">    jsonParser.nextString(&apos;a&apos;); //  [&quot;12345678&quot;, &quot;87654321&quot;],    &quot;n（前面有两个空格）  </span><br><span class="line">      </span><br><span class="line">    // 返回当前读取位置到第一次遇到字符串中(如&quot;0089&quot;)任意字符之间的字符串，同时该字符是trimmed的。（此处就是第一次遇到了89）  </span><br><span class="line">    jsonParser.nextTo(&quot;0089&quot;); //me&quot; : &quot;yuanzhifei  </span><br><span class="line">      </span><br><span class="line">    // 读取位置撤销一个  </span><br><span class="line">    jsonParser.back();  </span><br><span class="line">    jsonParser.next(); //i  </span><br><span class="line">      </span><br><span class="line">    // 读取位置前进到指定字符串处（包括字符串）  </span><br><span class="line">    jsonParser.skipPast(&quot;address&quot;);  </span><br><span class="line">    jsonParser.next(8); //&quot; : &#123; &quot;c  </span><br><span class="line">      </span><br><span class="line">    // 读取位置前进到执行字符处（不包括字符）  </span><br><span class="line">    jsonParser.skipTo(&apos;m&apos;);  </span><br><span class="line">    jsonParser.next(8); //married&quot;  </span><br><span class="line">&#125; catch (JSONException ex) &#123;  </span><br><span class="line">    // 异常处理代码  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line">      以下是一个标准的JSON请求实现过程：</span><br><span class="line"></span><br><span class="line">01</span><br><span class="line">HttpPost request = newHttpPost(url); </span><br><span class="line">02</span><br><span class="line">// 先封装一个 JSON 对象 </span><br><span class="line">03</span><br><span class="line">JSONObject param = newJSONObject(); </span><br><span class="line">04</span><br><span class="line">param.put(&quot;name&quot;, &quot;rarnu&quot;); </span><br><span class="line">05</span><br><span class="line">param.put(&quot;password&quot;, &quot;123456&quot;); </span><br><span class="line">06</span><br><span class="line">// 绑定到请求 Entry </span><br><span class="line">07</span><br><span class="line">StringEntity se = newStringEntity(param.toString());  </span><br><span class="line">08</span><br><span class="line">request.setEntity(se); </span><br><span class="line">09</span><br><span class="line">// 发送请求 </span><br><span class="line">10</span><br><span class="line">HttpResponse httpResponse = newDefaultHttpClient().execute(request); </span><br><span class="line">11</span><br><span class="line">// 得到应答的字符串，这也是一个 JSON 格式保存的数据 </span><br><span class="line">12</span><br><span class="line">String retSrc = EntityUtils.toString(httpResponse.getEntity()); </span><br><span class="line">13</span><br><span class="line">// 生成 JSON 对象 </span><br><span class="line">14</span><br><span class="line">JSONObject result = newJSONObject( retSrc); </span><br><span class="line">15</span><br><span class="line">String token = result.get(&quot;token&quot;);</span><br><span class="line"></span><br><span class="line">        下面这个是自己修改别人的小例子，主要是加一些注释和讲解，这个例子主要是使用android进行json解析。 </span><br><span class="line">1</span><br><span class="line">单数据&#123;&apos;singer&apos;:&#123;&apos;id&apos;:01,&apos;name&apos;:&apos;tom&apos;,&apos;gender&apos;:&apos;男&apos;&#125;&#125;</span><br><span class="line">2</span><br><span class="line">多个数据&#123;&quot;singers&quot;:[</span><br><span class="line">3</span><br><span class="line">        &#123;&apos;id&apos;:02,&apos;name&apos;:&apos;tom&apos;,&apos;gender&apos;:&apos;男&apos;&#125;,</span><br><span class="line">4</span><br><span class="line">         &#123;&apos;id&apos;:03,&apos;name&apos;:&apos;jerry,&apos;gender&apos;:&apos;男&apos;&#125;,</span><br><span class="line">5</span><br><span class="line">&#123;&apos;id&apos;:04,&apos;name&apos;:&apos;jim,&apos;gender&apos;:&apos;男&apos;&#125;,</span><br><span class="line">6</span><br><span class="line">&#123;&apos;id&apos;:05,&apos;name&apos;:&apos;lily,&apos;gender&apos;:&apos;女&apos;&#125;]&#125;</span><br><span class="line">        下面的类主要是解析单个数据parseJson（）和多个数据的方法parseJsonMulti（）: </span><br><span class="line">01</span><br><span class="line">public class JsonActivity extends Activity &#123; </span><br><span class="line">02</span><br><span class="line">    /** Called when the activity is first created. */ </span><br><span class="line">03</span><br><span class="line">    private TextView tvJson; </span><br><span class="line">04</span><br><span class="line">    private Button btnJson; </span><br><span class="line">05</span><br><span class="line">    private Button btnJsonMulti; </span><br><span class="line">06</span><br><span class="line">    @Override </span><br><span class="line">07</span><br><span class="line">    public void onCreate(Bundle savedInstanceState) &#123; </span><br><span class="line">08</span><br><span class="line">        super.onCreate(savedInstanceState); </span><br><span class="line">09</span><br><span class="line">        setContentView(R.layout.main); </span><br><span class="line">10</span><br><span class="line">        tvJson = (TextView) this.findViewById(R.id.tvJson); </span><br><span class="line">11</span><br><span class="line">        btnJson = (Button) this.findViewById(R.id.btnJson); </span><br><span class="line">12</span><br><span class="line">        btnJsonMulti = (Button) this.findViewById(R.id.btnJsonMulti); </span><br><span class="line">13</span><br><span class="line">        btnJson.setOnClickListener(new View.OnClickListener() &#123; </span><br><span class="line">14</span><br><span class="line">            @Override </span><br><span class="line">15</span><br><span class="line">            public void onClick(View v) &#123; </span><br><span class="line">16</span><br><span class="line">                // url </span><br><span class="line">17</span><br><span class="line">                // String strUrl = &quot;http://10.158.166.110:8080/AndroidServer/JsonServlet&quot;; </span><br><span class="line">18</span><br><span class="line">                String strUrl = ServerPageUtil.getStrUrl(UrlsOfServer.JSON_SINGER); </span><br><span class="line">19</span><br><span class="line">                //获得返回的Json字符串 </span><br><span class="line">20</span><br><span class="line">                String strResult = connServerForResult(strUrl); </span><br><span class="line">21</span><br><span class="line">                //解析Json字符串 </span><br><span class="line">22</span><br><span class="line">                parseJson(strResult); </span><br><span class="line">23</span><br><span class="line">            &#125; </span><br><span class="line">24</span><br><span class="line">        &#125;); </span><br><span class="line">25</span><br><span class="line">        btnJsonMulti.setOnClickListener(new View.OnClickListener() &#123; </span><br><span class="line">26</span><br><span class="line">            @Override </span><br><span class="line">27</span><br><span class="line">            public void onClick(View v) &#123; </span><br><span class="line">28</span><br><span class="line">                String strUrl = ServerPageUtil.getStrUrl(UrlsOfServer.JSON_SINGERS); </span><br><span class="line">29</span><br><span class="line">                String strResult = connServerForResult(strUrl); </span><br><span class="line">30</span><br><span class="line">                //获得多个Singer </span><br><span class="line">31</span><br><span class="line">                parseJsonMulti(strResult); </span><br><span class="line">32</span><br><span class="line">            &#125; </span><br><span class="line">33</span><br><span class="line">        &#125;); </span><br><span class="line">34</span><br><span class="line">    &#125; </span><br><span class="line">35</span><br><span class="line">    private String connServerForResult(String strUrl) &#123; </span><br><span class="line">36</span><br><span class="line">        // HttpGet对象 </span><br><span class="line">37</span><br><span class="line">        HttpGet httpRequest = new HttpGet(strUrl); </span><br><span class="line">38</span><br><span class="line">        String strResult = &quot;&quot;; </span><br><span class="line">39</span><br><span class="line">        try &#123; </span><br><span class="line">40</span><br><span class="line">            // HttpClient对象 </span><br><span class="line">41</span><br><span class="line">            HttpClient httpClient = new DefaultHttpClient(); </span><br><span class="line">42</span><br><span class="line">            // 获得HttpResponse对象 </span><br><span class="line">43</span><br><span class="line">            HttpResponse httpResponse = httpClient.execute(httpRequest); </span><br><span class="line">44</span><br><span class="line">            if (httpResponse.getStatusLine().getStatusCode() == HttpStatus.SC_OK) &#123; </span><br><span class="line">45</span><br><span class="line">                // 取得返回的数据 </span><br><span class="line">46</span><br><span class="line">                strResult = EntityUtils.toString(httpResponse.getEntity()); </span><br><span class="line">47</span><br><span class="line">            &#125; </span><br><span class="line">48</span><br><span class="line">        &#125; catch (ClientProtocolException e) &#123; </span><br><span class="line">49</span><br><span class="line">            tvJson.setText(&quot;protocol error&quot;); </span><br><span class="line">50</span><br><span class="line">            e.printStackTrace(); </span><br><span class="line">51</span><br><span class="line">        &#125; catch (IOException e) &#123; </span><br><span class="line">52</span><br><span class="line">            tvJson.setText(&quot;IO error&quot;); </span><br><span class="line">53</span><br><span class="line">            e.printStackTrace(); </span><br><span class="line">54</span><br><span class="line">        &#125; </span><br><span class="line">55</span><br><span class="line">        return strResult; </span><br><span class="line">56</span><br><span class="line">    &#125; </span><br><span class="line">57</span><br><span class="line">    // 普通Json数据解析 </span><br><span class="line">58</span><br><span class="line">    private void parseJson(String strResult) &#123; </span><br><span class="line">59</span><br><span class="line">        try &#123; </span><br><span class="line">60</span><br><span class="line">            JSONObject jsonObj = new JSONObject(strResult).getJSONObject(&quot;singer&quot;); </span><br><span class="line">61</span><br><span class="line">            int id = jsonObj.getInt(&quot;id&quot;); </span><br><span class="line">62</span><br><span class="line">            String name = jsonObj.getString(&quot;name&quot;); </span><br><span class="line">63</span><br><span class="line">            String gender = jsonObj.getString(&quot;gender&quot;); </span><br><span class="line">64</span><br><span class="line">            tvJson.setText(&quot;ID号&quot;+id + &quot;, 姓名：&quot; + name + &quot;,性别：&quot; + gender); </span><br><span class="line">65</span><br><span class="line">        &#125; catch (JSONException e) &#123; </span><br><span class="line">66</span><br><span class="line">            System.out.println(&quot;Json parse error&quot;); </span><br><span class="line">67</span><br><span class="line">            e.printStackTrace(); </span><br><span class="line">68</span><br><span class="line">        &#125; </span><br><span class="line">69</span><br><span class="line">    &#125; </span><br><span class="line">70</span><br><span class="line">    //解析多个数据的Json</span><br><span class="line">71</span><br><span class="line">    private void parseJsonMulti(String strResult) &#123; </span><br><span class="line">72</span><br><span class="line">        try &#123; </span><br><span class="line">73</span><br><span class="line">            JSONArray jsonObjs = new JSONObject(strResult).getJSONArray(&quot;singers&quot;); </span><br><span class="line">74</span><br><span class="line">            String s = &quot;&quot;; </span><br><span class="line">75</span><br><span class="line">            for(int i = 0; i &lt; jsonObjs.length() ; i++)&#123; </span><br><span class="line">76</span><br><span class="line">                JSONObject jsonObj = ((JSONObject)jsonObjs.opt(i)) </span><br><span class="line">77</span><br><span class="line">                .getJSONObject(&quot;singer&quot;); </span><br><span class="line">78</span><br><span class="line">                int id = jsonObj.getInt(&quot;id&quot;); </span><br><span class="line">79</span><br><span class="line">                String name = jsonObj.getString(&quot;name&quot;); </span><br><span class="line">80</span><br><span class="line">                String gender = jsonObj.getString(&quot;gender&quot;); </span><br><span class="line">81</span><br><span class="line">                s +=  &quot;ID号&quot;+id + &quot;, 姓名：&quot; + name + &quot;,性别：&quot; + gender+ &quot;\n&quot; ; </span><br><span class="line">82</span><br><span class="line">            &#125; </span><br><span class="line">83</span><br><span class="line">            tvJson.setText(s); </span><br><span class="line">84</span><br><span class="line">        &#125; catch (JSONException e) &#123; </span><br><span class="line">85</span><br><span class="line">            System.out.println(&quot;Jsons parse error !&quot;); </span><br><span class="line">86</span><br><span class="line">            e.printStackTrace(); </span><br><span class="line">87</span><br><span class="line">        &#125; </span><br><span class="line">88</span><br><span class="line">    &#125; </span><br><span class="line">89</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
	
	</div>
  <a type="button" href="/2016/05/14/Android-解析json/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-05-14 </div>
			<div class="article-title"><a href="/2016/05/14/Android-应用版本更新/" >Android 应用版本更新</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>一个好的应用软件都是需要好的维护，从初出版本到最后精品，这个过程需要版本不停的更新，那么如何让用户第一时间获取最新的应用安装包呢？那么就要求我们从第一个版本就要实现升级模块这一功能。</p>
<p>自动更新功能的实现原理，就是我们事先和后台协商好一个接口，我们在应用的主Activity里，去访问这个接口，如果需要更新，后台会返回一些数据(比 如，提示语；最新版本的url等)。然后我们给出提示框，用户点击开始下载，下载完成开始覆盖安装程序，这样用户的应用就保持最新的拉。</p>
<p>为了让大家容易理解，我像往常一样准备一个小例子，这里为了方便我就省去了和后台交互部分了。步骤分别如下：</p>
<p>第一步：新建一个Android工程命名为:UpdateDemo.代码结构如下图所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br></pre></td><td class="code"><pre><span class="line">Android 软件自动更新功能的实现！！！</span><br><span class="line"></span><br><span class="line">第二步：新建一个UpdateManager.java类，负责软件更新功能模块，代码如下：</span><br><span class="line"></span><br><span class="line">001</span><br><span class="line">package com.tutor.update;</span><br><span class="line">002</span><br><span class="line"></span><br><span class="line">003</span><br><span class="line">import java.io.File;</span><br><span class="line">004</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">005</span><br><span class="line">import java.io.IOException;</span><br><span class="line">006</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">007</span><br><span class="line">import java.net.HttpURLConnection;</span><br><span class="line">008</span><br><span class="line">import java.net.MalformedURLException;</span><br><span class="line">009</span><br><span class="line">import java.net.URL;</span><br><span class="line">010</span><br><span class="line"></span><br><span class="line">011</span><br><span class="line"></span><br><span class="line">012</span><br><span class="line">import android.app.AlertDialog;</span><br><span class="line">013</span><br><span class="line">import android.app.Dialog;</span><br><span class="line">014</span><br><span class="line">import android.app.AlertDialog.Builder;</span><br><span class="line">015</span><br><span class="line">import android.content.Context;</span><br><span class="line">016</span><br><span class="line">import android.content.DialogInterface;</span><br><span class="line">017</span><br><span class="line">import android.content.Intent;</span><br><span class="line">018</span><br><span class="line">import android.content.DialogInterface.OnClickListener;</span><br><span class="line">019</span><br><span class="line">import android.net.Uri;</span><br><span class="line">020</span><br><span class="line">import android.os.Handler;</span><br><span class="line">021</span><br><span class="line">import android.os.Message;</span><br><span class="line">022</span><br><span class="line">import android.view.LayoutInflater;</span><br><span class="line">023</span><br><span class="line">import android.view.View;</span><br><span class="line">024</span><br><span class="line">import android.widget.ProgressBar;</span><br><span class="line">025</span><br><span class="line"></span><br><span class="line">026</span><br><span class="line">public class UpdateManager &#123;</span><br><span class="line">027</span><br><span class="line"></span><br><span class="line">028</span><br><span class="line">    private Context mContext;</span><br><span class="line">029</span><br><span class="line">     </span><br><span class="line">030</span><br><span class="line">    //提示语</span><br><span class="line">031</span><br><span class="line">    private String updateMsg = &quot;有最新的软件包哦，亲快下载吧~&quot;;</span><br><span class="line">032</span><br><span class="line">     </span><br><span class="line">033</span><br><span class="line">    //返回的安装包url</span><br><span class="line">034</span><br><span class="line">    privateString apkUrl = &quot;http://softfile.3g.qq.com:8080/msoft/179/24659/43549/qq_hd_mini_1.4.apk&quot;;</span><br><span class="line">035</span><br><span class="line">     </span><br><span class="line">036</span><br><span class="line">     </span><br><span class="line">037</span><br><span class="line">    private Dialog noticeDialog;</span><br><span class="line">038</span><br><span class="line">     </span><br><span class="line">039</span><br><span class="line">    private Dialog downloadDialog;</span><br><span class="line">040</span><br><span class="line">     /* 下载包安装路径 */</span><br><span class="line">041</span><br><span class="line">    private static final String savePath = &quot;/sdcard/updatedemo/&quot;;</span><br><span class="line">042</span><br><span class="line">     </span><br><span class="line">043</span><br><span class="line">    private static final String saveFileName = savePath + &quot;UpdateDemoRelease.apk&quot;;</span><br><span class="line">044</span><br><span class="line"></span><br><span class="line">045</span><br><span class="line">    /* 进度条与通知ui刷新的handler和msg常量 */</span><br><span class="line">046</span><br><span class="line">    private ProgressBar mProgress;</span><br><span class="line">047</span><br><span class="line"></span><br><span class="line">048</span><br><span class="line">     </span><br><span class="line">049</span><br><span class="line">    private static final int DOWN_UPDATE = 1;</span><br><span class="line">050</span><br><span class="line">     </span><br><span class="line">051</span><br><span class="line">    private static final int DOWN_OVER = 2;</span><br><span class="line">052</span><br><span class="line">     </span><br><span class="line">053</span><br><span class="line">    private int progress;</span><br><span class="line">054</span><br><span class="line">     </span><br><span class="line">055</span><br><span class="line">    private Thread downLoadThread;</span><br><span class="line">056</span><br><span class="line">     </span><br><span class="line">057</span><br><span class="line">    private boolean interceptFlag = false;</span><br><span class="line">058</span><br><span class="line">     </span><br><span class="line">059</span><br><span class="line">    private Handler mHandler = new Handler()&#123;</span><br><span class="line">060</span><br><span class="line">        public void handleMessage(Message msg) &#123;</span><br><span class="line">061</span><br><span class="line">            switch (msg.what) &#123;</span><br><span class="line">062</span><br><span class="line">            case DOWN_UPDATE:</span><br><span class="line">063</span><br><span class="line">                mProgress.setProgress(progress);</span><br><span class="line">064</span><br><span class="line">                break;</span><br><span class="line">065</span><br><span class="line">            case DOWN_OVER:</span><br><span class="line">066</span><br><span class="line">                 </span><br><span class="line">067</span><br><span class="line">                installApk();</span><br><span class="line">068</span><br><span class="line">                break;</span><br><span class="line">069</span><br><span class="line">            default:</span><br><span class="line">070</span><br><span class="line">                break;</span><br><span class="line">071</span><br><span class="line">            &#125;</span><br><span class="line">072</span><br><span class="line">        &#125;;</span><br><span class="line">073</span><br><span class="line">    &#125;;</span><br><span class="line">074</span><br><span class="line">     </span><br><span class="line">075</span><br><span class="line">    public UpdateManager(Context context) &#123;</span><br><span class="line">076</span><br><span class="line">        this.mContext = context;</span><br><span class="line">077</span><br><span class="line">    &#125;</span><br><span class="line">078</span><br><span class="line">     </span><br><span class="line">079</span><br><span class="line">    //外部接口让主Activity调用</span><br><span class="line">080</span><br><span class="line">    public void checkUpdateInfo()&#123;</span><br><span class="line">081</span><br><span class="line">        showNoticeDialog();</span><br><span class="line">082</span><br><span class="line">    &#125;</span><br><span class="line">083</span><br><span class="line">     </span><br><span class="line">084</span><br><span class="line">     </span><br><span class="line">085</span><br><span class="line">    private void showNoticeDialog()&#123;</span><br><span class="line">086</span><br><span class="line">        AlertDialog.Builder builder = new Builder(mContext);</span><br><span class="line">087</span><br><span class="line">        builder.setTitle(&quot;软件版本更新&quot;);</span><br><span class="line">088</span><br><span class="line">        builder.setMessage(updateMsg);</span><br><span class="line">089</span><br><span class="line">        builder.setPositiveButton(&quot;下载&quot;, new OnClickListener() &#123;        </span><br><span class="line">090</span><br><span class="line">            @Override</span><br><span class="line">091</span><br><span class="line">            public void onClick(DialogInterface dialog, int which) &#123;</span><br><span class="line">092</span><br><span class="line">                dialog.dismiss();</span><br><span class="line">093</span><br><span class="line">                showDownloadDialog();          </span><br><span class="line">094</span><br><span class="line">            &#125;</span><br><span class="line">095</span><br><span class="line">        &#125;);</span><br><span class="line">096</span><br><span class="line">        builder.setNegativeButton(&quot;以后再说&quot;, new OnClickListener() &#123;          </span><br><span class="line">097</span><br><span class="line">            @Override</span><br><span class="line">098</span><br><span class="line">            public void onClick(DialogInterface dialog, int which) &#123;</span><br><span class="line">099</span><br><span class="line">                dialog.dismiss();              </span><br><span class="line">100</span><br><span class="line">            &#125;</span><br><span class="line">101</span><br><span class="line">        &#125;);</span><br><span class="line">102</span><br><span class="line">        noticeDialog = builder.create();</span><br><span class="line">103</span><br><span class="line">        noticeDialog.show();</span><br><span class="line">104</span><br><span class="line">    &#125;</span><br><span class="line">105</span><br><span class="line">     </span><br><span class="line">106</span><br><span class="line">    private void showDownloadDialog()&#123;</span><br><span class="line">107</span><br><span class="line">        AlertDialog.Builder builder = new Builder(mContext);</span><br><span class="line">108</span><br><span class="line">        builder.setTitle(&quot;软件版本更新&quot;);</span><br><span class="line">109</span><br><span class="line">         </span><br><span class="line">110</span><br><span class="line">        final LayoutInflater inflater = LayoutInflater.from(mContext);</span><br><span class="line">111</span><br><span class="line">        View v = inflater.inflate(R.layout.progress, null);</span><br><span class="line">112</span><br><span class="line">        mProgress = (ProgressBar)v.findViewById(R.id.progress);</span><br><span class="line">113</span><br><span class="line">         </span><br><span class="line">114</span><br><span class="line">        builder.setView(v);</span><br><span class="line">115</span><br><span class="line">        builder.setNegativeButton(&quot;取消&quot;, new OnClickListener() &#123;</span><br><span class="line">116</span><br><span class="line">            @Override</span><br><span class="line">117</span><br><span class="line">            public void onClick(DialogInterface dialog, int which) &#123;</span><br><span class="line">118</span><br><span class="line">                dialog.dismiss();</span><br><span class="line">119</span><br><span class="line">                interceptFlag = true;</span><br><span class="line">120</span><br><span class="line">            &#125;</span><br><span class="line">121</span><br><span class="line">        &#125;);</span><br><span class="line">122</span><br><span class="line">        downloadDialog = builder.create();</span><br><span class="line">123</span><br><span class="line">        downloadDialog.show();</span><br><span class="line">124</span><br><span class="line">         </span><br><span class="line">125</span><br><span class="line">        downloadApk();</span><br><span class="line">126</span><br><span class="line">    &#125;</span><br><span class="line">127</span><br><span class="line">     </span><br><span class="line">128</span><br><span class="line">    private Runnable mdownApkRunnable = new Runnable() &#123;   </span><br><span class="line">129</span><br><span class="line">        @Override</span><br><span class="line">130</span><br><span class="line">        public void run() &#123;</span><br><span class="line">131</span><br><span class="line">            try &#123;</span><br><span class="line">132</span><br><span class="line">                URL url = new URL(apkUrl);</span><br><span class="line">133</span><br><span class="line">             </span><br><span class="line">134</span><br><span class="line">                HttpURLConnection conn = (HttpURLConnection)url.openConnection();</span><br><span class="line">135</span><br><span class="line">                conn.connect();</span><br><span class="line">136</span><br><span class="line">                int length = conn.getContentLength();</span><br><span class="line">137</span><br><span class="line">                InputStream is = conn.getInputStream();</span><br><span class="line">138</span><br><span class="line">                 </span><br><span class="line">139</span><br><span class="line">                File file = new File(savePath);</span><br><span class="line">140</span><br><span class="line">                if(!file.exists())&#123;</span><br><span class="line">141</span><br><span class="line">                    file.mkdir();</span><br><span class="line">142</span><br><span class="line">                &#125;</span><br><span class="line">143</span><br><span class="line">                String apkFile = saveFileName;</span><br><span class="line">144</span><br><span class="line">                File ApkFile = new File(apkFile);</span><br><span class="line">145</span><br><span class="line">                FileOutputStream fos = new FileOutputStream(ApkFile);</span><br><span class="line">146</span><br><span class="line">                 </span><br><span class="line">147</span><br><span class="line">                int count = 0;</span><br><span class="line">148</span><br><span class="line">                byte buf[] = new byte[1024];</span><br><span class="line">149</span><br><span class="line">                 </span><br><span class="line">150</span><br><span class="line">                do&#123;                </span><br><span class="line">151</span><br><span class="line">                    int numread = is.read(buf);</span><br><span class="line">152</span><br><span class="line">                    count += numread;</span><br><span class="line">153</span><br><span class="line">                    progress =(int)(((float)count / length) * 100);</span><br><span class="line">154</span><br><span class="line">                    //更新进度</span><br><span class="line">155</span><br><span class="line">                    mHandler.sendEmptyMessage(DOWN_UPDATE);</span><br><span class="line">156</span><br><span class="line">                    if(numread &lt;= 0)&#123;   </span><br><span class="line">157</span><br><span class="line">                        //下载完成通知安装</span><br><span class="line">158</span><br><span class="line">                        mHandler.sendEmptyMessage(DOWN_OVER);</span><br><span class="line">159</span><br><span class="line">                        break;</span><br><span class="line">160</span><br><span class="line">                    &#125;</span><br><span class="line">161</span><br><span class="line">                    fos.write(buf,0,numread);</span><br><span class="line">162</span><br><span class="line">                &#125;while(!interceptFlag);//点击取消就停止下载.</span><br><span class="line">163</span><br><span class="line">                 </span><br><span class="line">164</span><br><span class="line">                fos.close();</span><br><span class="line">165</span><br><span class="line">                is.close();</span><br><span class="line">166</span><br><span class="line">            &#125; catch (MalformedURLException e) &#123;</span><br><span class="line">167</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">168</span><br><span class="line">            &#125; catch(IOException e)&#123;</span><br><span class="line">169</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">170</span><br><span class="line">            &#125;</span><br><span class="line">171</span><br><span class="line">             </span><br><span class="line">172</span><br><span class="line">        &#125;</span><br><span class="line">173</span><br><span class="line">    &#125;;</span><br><span class="line">174</span><br><span class="line">     </span><br><span class="line">175</span><br><span class="line">     /**</span><br><span class="line">176</span><br><span class="line">     * 下载apk</span><br><span class="line">177</span><br><span class="line">     * @param url</span><br><span class="line">178</span><br><span class="line">     */</span><br><span class="line">179</span><br><span class="line">     </span><br><span class="line">180</span><br><span class="line">    private void downloadApk()&#123;</span><br><span class="line">181</span><br><span class="line">        downLoadThread = new Thread(mdownApkRunnable);</span><br><span class="line">182</span><br><span class="line">        downLoadThread.start();</span><br><span class="line">183</span><br><span class="line">    &#125;</span><br><span class="line">184</span><br><span class="line">     /**</span><br><span class="line">185</span><br><span class="line">     * 安装apk</span><br><span class="line">186</span><br><span class="line">     * @param url</span><br><span class="line">187</span><br><span class="line">     */</span><br><span class="line">188</span><br><span class="line">    private void installApk()&#123;</span><br><span class="line">189</span><br><span class="line">        File apkfile = new File(saveFileName);</span><br><span class="line">190</span><br><span class="line">        if (!apkfile.exists()) &#123;</span><br><span class="line">191</span><br><span class="line">            return;</span><br><span class="line">192</span><br><span class="line">        &#125;   </span><br><span class="line">193</span><br><span class="line">        Intent i = new Intent(Intent.ACTION_VIEW);</span><br><span class="line">194</span><br><span class="line">        i.setDataAndType(Uri.parse(&quot;file://&quot;+ apkfile.toString()), &quot;application/vnd.android.package-archive&quot;);</span><br><span class="line">195</span><br><span class="line">        mContext.startActivity(i);</span><br><span class="line">196</span><br><span class="line">     </span><br><span class="line">197</span><br><span class="line">    &#125;</span><br><span class="line">198</span><br><span class="line">&#125;</span><br><span class="line">第三步：在MainActivity.java也就是主Activity调用,代码如下:</span><br><span class="line">01</span><br><span class="line">package com.tutor.update;</span><br><span class="line">02</span><br><span class="line"></span><br><span class="line">03</span><br><span class="line">import android.app.Activity;</span><br><span class="line">04</span><br><span class="line">import android.os.Bundle;</span><br><span class="line">05</span><br><span class="line"></span><br><span class="line">06</span><br><span class="line">public class MainAcitivity extends Activity &#123;</span><br><span class="line">07</span><br><span class="line">     </span><br><span class="line">08</span><br><span class="line"></span><br><span class="line">09</span><br><span class="line">    private UpdateManager mUpdateManager;</span><br><span class="line">10</span><br><span class="line">    @Override</span><br><span class="line">11</span><br><span class="line">    public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">12</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">13</span><br><span class="line">        setContentView(R.layout.main);</span><br><span class="line">14</span><br><span class="line">         </span><br><span class="line">15</span><br><span class="line">        //这里来检测版本是否需要更新</span><br><span class="line">16</span><br><span class="line">        mUpdateManager = new UpdateManager(this);</span><br><span class="line">17</span><br><span class="line">        mUpdateManager.checkUpdateInfo();</span><br><span class="line">18</span><br><span class="line">    &#125;    </span><br><span class="line">19</span><br><span class="line">&#125;</span><br><span class="line">第四步：添加程序所用的资源与权限：</span><br><span class="line">下载的时候用到了ProgressBar,所以事先写了一个progress.xml布局文件，代码如下:</span><br><span class="line"></span><br><span class="line">01</span><br><span class="line">&lt;!--?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?--&gt;</span><br><span class="line">02</span><br><span class="line"></span><br><span class="line">03</span><br><span class="line"></span><br><span class="line">04</span><br><span class="line"></span><br><span class="line">05</span><br><span class="line"></span><br><span class="line">06</span><br><span class="line">&lt;linearlayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;android:layout_width=&quot;fill_parent&quot; android:layout_height=&quot;wrap_content&quot;&gt;  </span><br><span class="line">07</span><br><span class="line"></span><br><span class="line">08</span><br><span class="line">  </span><br><span class="line">09</span><br><span class="line">  </span><br><span class="line">10</span><br><span class="line">  </span><br><span class="line">11</span><br><span class="line">  </span><br><span class="line">12</span><br><span class="line"> &lt;progressbar style=&quot;android:attr/progressBarStyleHorizontal;&quot;android:layout_width=&quot;fill_parent&quot; android:layout_height=&quot;wrap_content&quot;android:id=&quot;@+id/progress&quot;&gt;</span><br><span class="line">13</span><br><span class="line">  </span><br><span class="line">14</span><br><span class="line">  </span><br><span class="line">15</span><br><span class="line">  </span><br><span class="line">16</span><br><span class="line">  </span><br><span class="line">17</span><br><span class="line"> &lt;/progressbar&gt;</span><br><span class="line">18</span><br><span class="line"></span><br><span class="line">19</span><br><span class="line"></span><br><span class="line">20</span><br><span class="line"></span><br><span class="line">21</span><br><span class="line"></span><br><span class="line">22</span><br><span class="line">&lt;/linearlayout&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">下载的时候用到了网</span><br><span class="line">络部分，所以要在AndroidManifest.xml中添加网络权限，代码如下:</span><br></pre></td></tr></table></figure>
<p>1</p>
<p><uses-permission android:name="android.permission.INTERNET"></uses-permission></p>
<p>```<br>第五步:运行查看效果如下:<br>Android 软件自动更新功能的实现！！！     Android 软件自动更新功能的实现！！！</p>
<p> 图一:提示有最新包                                                                                   图二：点击开始下载</p>
<p>Android 软件自动更新功能的实现！！！</p>
<p>图三：下载完开始安装，我这里模拟器空间不足了。</p>

	
	</div>
  <a type="button" href="/2016/05/14/Android-应用版本更新/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-05-14 </div>
			<div class="article-title"><a href="/2016/05/14/Android-Notification的使用/" >Android Notification的使用</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<p>1：获取NotificationManager:<br>NotificationManager m_NotificationManager=(NotificationManager)this.getSystemService(NOTIFICATION_SERVICE);</p>
<p>2:定义一个Notification:<br>  Notification  m_Notification=new Notification();</p>
<p>3:设置Notification的各种属性：<br> //设置通知在状态栏显示的图标<br>m_Notification.icon=R.drawable.icon;<br> //当我们点击通知时显示的内容<br>m_Notification.tickerText=”Button1 通知内容…..”;</p>
<p>通知时发出的默认声音<br>m_Notification.defaults=Notification.DEFAULT_SOUND;<br>//设置通知显示的参数<br>Intent   m_Intent=new Intent(NotificationDemo.this,DesActivity.class);<br>PendingIntent m_PendingIntent=PendingIntent.getActivity(NotificationDemo.this, 0, m_Intent, 0);<br>m_Notification.setLatestEventInfo(NotificationDemo.this, “Button1”, “Button1通知”,m_PendingIntent );<br>//这个可以理解为开始执行这个通知<br>m_NotificationManager.notify(0,m_Notification);</p>
<p>4：既然可以增加同样我们也可以删除。当然是只是删除你自己增加的。<br>  m_NotificationManager.cancel(0);<br>  这里的0是一个ID号码，和notify第一个参数0一样。<br>这也就完成了，添加删除工作。</p>

	
	</div>
  <a type="button" href="/2016/05/14/Android-Notification的使用/#more" class="btn btn-default more">阅读此文</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-05-13 </div>
			<div class="article-title"><a href="/2016/05/13/Android-短信发送/" >Android 短信发送</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
	
	
		<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 短信管理模块</span><br><span class="line">public void SMSclick(View view) &#123;</span><br><span class="line"></span><br><span class="line">Log.v(&quot;sms&quot;, &quot;sms&quot;);</span><br><span class="line">// 调用Android系统API发送短信</span><br><span class="line">Uri uri = Uri.parse(&quot;smsto:5556&quot;);</span><br><span class="line">Intent intent = new Intent(Intent.ACTION_SENDTO, uri);</span><br><span class="line">intent.putExtra(&quot;sms_body&quot;, &quot;android...&quot;);</span><br><span class="line">startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//发送短信管理模块</span><br><span class="line">public void SMSsend(View view)&#123;</span><br><span class="line">  </span><br><span class="line">    PendingIntent pi = PendingIntent.getActivity(this, 0,    new Intent(this, MainActivity.class), 0);</span><br><span class="line">  </span><br><span class="line">    SmsManager sms = SmsManager.getDefault();</span><br><span class="line">  </span><br><span class="line">    sms.sendTextMessage(&quot;5554&quot;, null, &quot;aa&quot;, pi, null);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
	
	</div>
  <a type="button" href="/2016/05/13/Android-短信发送/#more" class="btn btn-default more">阅读此文</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>上一页</a></li>
        

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/2/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="搜索" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
		
			
	<div class="widget">
		<h4>标签云</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/Android/">Android<span>14</span></a></li>
		
			<li><a href="/tags/Java/">Java<span>1</span></a></li>
		
			<li><a href="/tags/博客/">博客<span>2</span></a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>最新文章</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2016/05/14/Android_条码扫描二维码扫描/" ><i class="fa fa-file-o"></i>Android_条码扫描二维码</a>
      </li>
    
      <li>
        <a href="/2016/05/14/Android_Afinal框架/" ><i class="fa fa-file-o"></i>Android_Afinal框架</a>
      </li>
    
      <li>
        <a href="/2016/05/14/Android_消息推送/" ><i class="fa fa-file-o"></i>Android 消息推送</a>
      </li>
    
      <li>
        <a href="/2016/05/14/Json_反序列化/" ><i class="fa fa-file-o"></i>Json反序列化</a>
      </li>
    
      <li>
        <a href="/2016/05/14/Android_检查是否联网/" ><i class="fa fa-file-o"></i>Android_检查是否联网</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>链接</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="https://github.com/wzpan/freemind/" title="Freemind's Github repository." target="_blank"]);">Freemind</a></li>
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/wzpan" title="My Github account." target="_blank"]);">My Github</a></li>
	
		<li><i class="fa fa-linkedin"></i><a href="http://www.linkedin.com/in/hahack" title="My Linkin account." target="_blank"]);">My LinkedIn</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->

	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2016 huanxingxyz
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
