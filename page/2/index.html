<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>田鹏飞的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="田鹏飞的个人博客">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="田鹏飞的个人博客">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="田鹏飞的个人博客">
<meta name="twitter:description">
  
    <link rel="alternate" href="/atom.xml" title="田鹏飞的个人博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">田鹏飞的个人博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">你若盛开，蝴蝶自来</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Unity3D第一人称射击游戏（推荐）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/14/Unity3D第一人称射击游戏（推荐）/" class="article-date">
  <time datetime="2016-05-14T14:08:26.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/14/Unity3D第一人称射击游戏（推荐）/">Unity3D第一人称射击游戏（推荐）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>第一部分：简介</p>
<p>这个教程中，我们详细了解下如何制作一个简单的第一人称射击游戏（FPS）。其中将介绍一些基本的3D游戏编程的概念和一些关于怎样如游戏程序员般思考的技巧。</p>
<p>前提</p>
<p>这个教程假定你已经熟悉软件Unity基本操作，掌握了基本的脚本概念。</p>
<p>创建新工程</p>
<p>下载FPS_Tutorial.zip压缩文件，解压，在Unity中打开工程文件。</p>
<p>从Unity安装目录导入Standard Assets资源包。</p>
<p>导入工程后，你会在Unity工程面板中的“Standard Assets”文件夹下看见这些资源内容。当我们导入新资源时，最好安装按照资源功能对其分组，例如：火箭、爆炸、音频等。</p>
<p>设置游戏环境</p>
<p>导入资源后，你会注意到在工程面板中有许多文件夹。</p>
<p>工程面板中，从文件夹“Object/mainLevelMesh”中选择“mainLevelMesh”。</p>
<p>在参数面板，FBXImporter选项中，你会发现“Generate Colliders”选项，勾选此选项。如果不做这一步，游戏中玩家会穿越地面直接掉下深渊（实际是开启“碰撞”，产生交互）</p>
<p>把“mainLevelMesh”拖放到场景中。</p>
<p>场景中不需要添加灯光，这关全部场景已经全部应用了灯光贴图。整个场景对所有灯光进行了灯光贴图渲染，使用了“预烘焙阴影”。灯光贴图对显示效果有很大帮助，特别是复杂灯光环境。</p>
<p>下面可以在场景中添加一个角色了。</p>
<p>添加主要角色</p>
<p>下面在场景中增加一个可以操控的角色物体。Unity针对第一人称射击游戏预置了许多内置的控制器，在工程面板Standard Assets-&gt;Prefabs下。</p>
<p>添加第一人称控制器，点击工程面板Standard Assets旁边的小三角，弹出资源列表。找到Prefabs文件夹，点击小三角形，弹出资源列表。把“First person controller”拖到场景里。</p>
<p>这时场景中会出现一个代表玩家的圆柱体，三个大箭头代表物体在3D空间中的位置（如果没有看见箭头，选择物体，按“W”键），白色面代表物体当前视角。现在FPS控制器处于默认视角位置，通过移动它可以改变游戏视野。把角色移动到游戏环境关卡地面上面的位置。</p>
<p>Main Camera现在已经没有用处了，可以删掉了。</p>
<p>点击“Play”键，现在应该可以通过使用鼠标和键盘在本关卡地形中四处移动了（光标或者“W,A,S,D”）</p>
<p>现在我们创建了一个非常简单的FSP，下面我们给角色添加武器。</p>
<p>增加武器</p>
<p>下面我们将给游戏角色一个类似榴弹的物体，可以在游戏中发射。要实现这个功能，需要创建一些脚本语言来在Unity中告知这个武器如何动作。</p>
<p>那么我们具体要实现什么呢？我们要使游戏角色能在摄像机的任意位置开火。但是，我们还是首先来思考一下游戏角色和武器。游戏角色游戏中是第一人称的视角，所以摄像机的位置与眼睛平行。如果玩家使用武器射击，武器应该是在角色的手部位置开火而不是眼睛的位置。这样我们就要增加一个“game object”（游戏物体）来代表榴弹发射器，同时把它放置在游戏角色手持武器时武器所处的位置。这样就保证了开火的位置没有问题。</p>
<p>创建武器发射器</p>
<p>首先，创建一个“game object”代表榴弹发射器。游戏物体是3D世界中的任一物体（角色、关卡、声音），零件就是游戏物体的属性。因此我们还需要对游戏物体添加零件：</p>
<p>从主菜单栏选择GameObject&gt;Great Empty，并在层级面板中（Hierarchy）命名为“Launcher”。注意，空物体在场景中是看不见的，只是用它来作放置飞弹发射器。</p>
<p>现在在场景中把视野推近到FPS控制器，便于我们放置武器发射器。</p>
<p>层级面板中选择FPS控制器，确保鼠标处于场景视图中，按“F”键。使窗口以当前选择的物体为中心。</p>
<p>层级面板中选择发射器，主菜单栏选择Game Object&gt;Move to view。注意发射器如何移动到FPS控制器附近的。然后使用手柄，把发射器移动到大概角色手部的位置。</p>
<p>注意：可以通过设置这个物体的位置来设定游戏角色是左撇子还是右撇子，不需要写代码。</p>
<p>使Unity窗口模式是“2by3”模式（window&gt;Layouts&gt;2by3），点击播放键（play）。确保层级面板中点选了发射器，四处移动角色，同时观察场景窗口。你将发现发射器并没有随着角色一起运动（现在再次点击播放键停止运行游戏）</p>
<p>下面来解决这个问题，层级面板中，把发射器拖放到FPS控制器下面的主摄像机上。弹出的对话框点击“是”。再次运行游戏，观察场景窗口，发射器已经和角色运动一致了。这样我们就把发射器与摄像机关联起来了。</p>
<p>创建飞弹</p>
<p>下面我们来创建在玩家点击开火键时能够发射出来的飞弹。</p>
<p>我们先用一个简单物体-球体-代替飞弹。Unity主菜单栏点击Assets&gt;Creat&gt;Prefab创建一个预制（Prefab）物体，命名为“Missile”</p>
<p>创建一个球体（GameObject&gt;Create Object&gt;Sphere）</p>
<p>层级面板中，拖放球体到飞弹预制物体上（Missile），这时预制物体图标会变化。你可以从层级面板中删除球体。</p>
<p>技巧：游戏运行中产生的任何游戏物体都应该是预制物体（Prefab）。</p>
<p>编写飞弹发射器脚本</p>
<p>FPS控制器是一个包含了几个游戏物体和部件的预制物体。FPS控制器本身是一个只能沿Y轴旋转的圆柱体，因此，如果我们直接把发射器脚本赋予FPS控制器的话，是实现不了上下开火的。所以我们把脚本赋予控制器中的能够四周转动的主摄像机。</p>
<p>下面我们来编写第一个描述发射器行为的JavaScript代码。</p>
<p>点击Assets&gt;Greate&gt;JavaScript，创建一个空的JavaScript文档。一个名为“NewBehaviourScript”资源将会出现在工程面板中，把它更名为“MissileLauncher”</p>
<p>技巧：通过Unity&gt;Preferences点击External Script Editor，可以自定义外部脚本编辑器。</p>
<p>工程面板中创建一个“WeaponScripts”文件夹，放置我们所有的武器脚本。把MissileLauncher脚本和飞弹预制物体（Missile Prefab）拖到这个文件中。</p>
<p>我们来看看飞弹发射器的完整JavaScript脚本。</p>
<p>进一步思考一下，我们到底想实现什么效果？我们要检测玩家是否按了开火键，然后产生一枚飞弹，然后把它沿着玩家朝向的方向按照一定的速度发射出去。我们仔细的解剖一下脚本：</p>
<p>var projectile: Rigibody;</p>
<p>var speed=20;</p>
<p>function Update( )</p>
<p>{</p>
<p>这是脚本的开头部分，定义了一些属性，开启了“Update”的功能</p>
<p>if(Input.GetButtonDown(“Fire1”))</p>
<p>首先我们要检测玩家是否按了开火键，“开火1”映射的是鼠标左键和当前配置的键盘上的按键（可以通过主菜单栏的Editor&gt;Project Settings&gt;Input设定）</p>
<p>{</p>
<p>var instantiatedProjectile: Rigidbody=Instantiate(</p>
<p>projectile, transform.position,transform.rotation);</p>
<p>我们用变量来定义产生的物体。变量的类型是Rigibody（刚体），因为飞弹是具有物理属性的。</p>
<p>Unity中产生新物体使用的函数是Instantiate，它有三个参数，分别是：产生的物体、产生物体的3D空间位置、物体的旋转。它还有另一个语法结构，参照API手册，这里我们只使用这种结构。</p>
<p>第一个参数，projectile，代表我们想创建的物体。那么到底发射什么物体？具体产生的物体是可以手动设定的。实现方法：把Projectile定义为函数的外部变量，这样就可以在参数面板中显示出来。发射的物体也可以通过代码来创建，但如果你想使一个变量可调的话，还是用上面的方法。</p>
<p>第二个参数，transform.position，使产生的物体与发射器的空间位置一致。为什么就是发射器呢？因为如果要使飞弹产生的位置没有问题，脚本就要关联给发射器。（transform读取的transform数据就是被赋予脚本的游戏物体transform数据）</p>
<p>第三个参数transform.rotation，与第二个类似，只是它的值与发射器的旋转值是一样的。</p>
<p>instantiatedProjectile.Vellocity=</p>
<p>transform.TransformDirection(Vector3(0,0,speed));</p>
<p>代码的下一部分使飞弹产生运动。为了实现运动，我们要赋予飞弹一个速度，但是在哪个方向上（X，Y，Z）产生速度呢？在场景中，点击FPS控制器，出现运动箭头（如果没有出现，按“W”键），其中一个箭头是红色、一个是绿色、一个是蓝色。红色代表X轴，绿色代表Y轴，蓝色代表Z轴。因为蓝色指向的方向，与玩家面朝的方向一致，所以我们要在Z轴上给飞弹一个速度。</p>
<p>（Velocity）速度是instantiatedProjectile的一个属性。我们怎么知道的呢？因为instantiatedProjectile是刚体的一种，如果我们看看API手册，我们就会知道速度是刚体的属性中的一种。同时也看看刚体的其它属性。要设置速度，我们就必须在各个轴向上设定数值。但还有个小问题。3D空间中的物体一般使用两种坐标模型：本地坐标系和世界坐标系。在本地坐标系中，物体的轴向只与物体本身有关。在世界坐标系中，轴向是绝对的，例如：向上，对所有物体来讲向上的方向都是一样的。Rigidbody.Vellocity刚体物体速度必须使用世界坐标系。因此，定义速度时，需要把本地坐标系中的Z轴（朝前的方向）向转换成世界坐标系中的相应方向。可以用函数transform.TransformDirection，它有三个向量作为自变量。变量speed也应该定义成外部变量，便于后面在编辑器中直接调节数值。</p>
<p>Physics.IgnoreCollision(instantiatedProjectile.collider,</p>
<p>transform.root.collider);</p>
<p>}</p>
<p>}</p>
<p>最后，我们要关闭飞弹与游戏角色之间的碰撞。如果不这样做的话，飞弹产生的时候就可能与角色发生碰撞。可以在API手册IgnoreCollision下查询详细信息。</p>
<p>MissileLauncher.js全部完整代码如下：</p>
<p>var projectile : Rigidbody;</p>
<p>var speed = 20;</p>
<p>function Update()</p>
<p>{</p>
<p>if( Input.GetButtonDown( “Fire1″ ) )</p>
<p>{</p>
<p>var instantiatedProjectile : Rigidbody = Instantiate(</p>
<p>projectile, transform.position, transform.rotation );</p>
<p>instantiatedProjectile.velocity =</p>
<p>transform.TransformDirection( Vector3( 0, 0, speed ) );</p>
<p>Physics.IgnoreCollision( instantiatedProjectile. collider,</p>
<p>transform.root.collider );</p>
<p>}</p>
<p>}</p>
<p>把脚本MissileLauncher赋予FPS控制器中的发射器。在层级面板中点击发射器，检查一下参数面板下面是否显示了MissileLauncher script。</p>
<p>先前创建的飞弹的预制物体还没有与脚本中的变量projectile创建关联，我们需要在编辑器中创建一下。变量projectile只能与刚体关联，因此，首先我们要赋予飞弹一个Rigidbody。</p>
<p>工程面板中点击飞弹，然后从主菜单栏选择Components&gt;Physics&gt;Rigidbody。这样将会给我们想开火发射的飞弹一个刚体属性。我们必须确保想在游戏中发射的物体类型与脚本中外部变量要求的物体类型是同一类型的物体。</p>
<p>创建飞弹与脚本中变量projectile的链接。首先在层级面板中点击发射器，然后把飞弹的预制物体从工程面板中拖拽放置在发射器参数面板中MissileLauncher script部分上。</p>
<p>运行游戏的话，你会发现点击开火键可以发出一个受重力影响的小球了。</p>
<p>飞弹爆炸</p>
<p>下面，当飞弹与其他物体发生碰撞时，增加一个爆炸效果。要实现这个效果，我们要编写一段新脚本赋予飞弹。</p>
<p>创建一个新脚本，命名为Projectile。拖放到工程面板的WeaponScripts文件夹下。</p>
<p>那么我们想要脚本Projectile实现什么样的效果呢？我们要检测飞弹是否发生碰撞，然后在碰撞点产生一个爆炸效果。代码如下：</p>
<p>var explosion : GameObject;</p>
<p>function OnCollisionEnter( collision : Collision )</p>
<p>{</p>
<p>函数OnCollisionEnter内的程序代码的作用是计算被赋予脚本的物体是否与其他物体发生碰撞。</p>
<p>var contact: ContactPoint=collision.contacts[0];</p>
<p>在函数OnCollisionEnter中我们主要是要实现在3D空间中飞弹发生碰撞的点产生一个新爆炸。那么在何处了碰撞的呢？函数OnCollisionEnter就有个记录这个信息的功能。碰撞发生的点的信息储存在变量ContactPoint中。</p>
<p>var rotation=Quaternion.FromToRotation(Vector3.up,contact.normal);</p>
<p>var instantiatedExplosion:GameObject=Instantiate(</p>
<p>explosion,contact.point,rotation);</p>
<p>这里我们使用函数Instantiate来创建一个爆炸。我们已经知道函数instatiate有三个参数：（1）产生的物体（2）物体的3D空间位置（3）物体的旋转。</p>
<p>第一个参数，后面我们将会赋给一个带粒子系统的游戏物体。同时我们还想通过编辑器来实现这个功能，所以我们把变量设置为外部变量。</p>
<p>第二个参数，爆炸产生的点的位置，就是碰撞发生的位置。</p>
<p>第三个参数，爆炸旋转的设置，需要解释一下。我们需要爆炸体的Y轴方向与飞弹和其他物体发生碰撞的那个表面的法线方向一致。这就是说如果是墙面那么爆炸就面向外，如果是地板就朝上。那么实际上我们就是要使爆炸体在本地坐标系的Y轴与飞弹与之碰撞的物体的表面法线方向（世界坐标系）一致。</p>
<p>Destroy（gameObject）;</p>
<p>}</p>
<p>最后，我们要让飞弹碰撞后就从游戏中消失，通过函数Destroy（）实现，它的参数是gameObject（gameObject代表被赋予这个脚本的物体）。</p>
<p>Projectile.js全部代码如下：</p>
<p>var explosion : GameObject;</p>
<p>function OnCollisionEnter( collision : Collision )</p>
<p>{</p>
<p>var contact : ContactPoint = collision.contacts[0];</p>
<p>var rotation = Quaternion.FromToRotation( Vector3.up, contact.normal );</p>
<p>var instantiatedExplosion : GameObject = Instantiate(</p>
<p>explosion, contact.point, rotation );</p>
<p>Destroy( gameObject );</p>
<p>}</p>
<p>把脚本赋予飞弹预制物体（Missile prefab）。</p>
<p>下面我们要创建飞弹发生碰撞时所产生爆炸的爆炸效果物体。</p>
<p>首先，创建一个新的预制物体（命名为Explosion）用来存放爆炸效果资源。</p>
<p>标准资源包中（standard asset）有个不错的爆炸预制物体，粒子系统和灯光都设置好了。把这个爆炸预制物体（在Standard Assets/Particles/explosion中）拖放到层级面板。</p>
<p>调节这个爆炸效果的各个参数直到你觉得满意，然后把它从层级面板中拖放到工程面板中的爆炸预制物体（Explosion Prefab）中。</p>
<p>现在把爆炸配置给飞弹：</p>
<p>点选飞弹预制物体（Missile Prefab），在参数面板Explosion变量栏，拖放工程面板中的爆炸到上面。</p>
<p>定义爆炸的行为</p>
<p>下面我们要再创建一个脚本来定义爆炸自身的特性。</p>
<p>创建一个新的脚本-Explosion，放在Weapons文件夹中，双击脚本进行编辑。</p>
<p>脚本中另一个常用函数称为Start（）。当它配置给的物体是在游戏中产生的时候，函数Start（）中的代码只被执行一次。我们要实现的效果就是在一定时间后，在游戏中删除爆炸。我们通过函数Destroy（）的第二个参数实现，它的作用是定义执行删除前的时间长度。</p>
<p>var explosionTime=1.0;</p>
<p>function Start( )</p>
<p>{</p>
<p>Destroy(gameObject,explosionTime);</p>
<p>}</p>
<p>变量explosionTime设置成外部变量，方便调节。</p>
<p>新建脚本插入以上代码时，要删除函数Update（）。</p>
<p>把脚本Explosion赋予给爆炸预制物体。</p>
<p>音效</p>
<p>目前的游戏世界太安静了，让我们给爆炸效果增加点音效。</p>
<p>首先，给爆炸预制（Prefab）添加一段音频。</p>
<p>给爆炸添加音效前，我们首先要添加一个音源部件（Audio Source），在主菜单点击Component—Audio—Audio Source。你会发现音源部件有一个Audio Clip的属性。</p>
<p>把“RocketLauncherImpact”音效添加给爆炸预制体的AudioClip外部变量。Unity支持多种音频格式。</p>
<p>运行游戏，发射飞弹的时候就有声音了！</p>
<p>添加图形界面</p>
<p>下面我们来添加GUI，有点像头部显示设备（ＨＵＤ）。我们要做的ＧＵＩ非常简单，就一个准星。</p>
<p>添加一个准星：</p>
<p>工程栏中创建一个ＧＵＩ的文件夹。</p>
<p>创建一个新脚本，命名为“准星”（Ｃｒｏｓｓｈａｉｒ），拖到ＧＵＩ文件夹。</p>
<p>Ｃｒｏｓｓｈａｉｒ中写入下面的脚本：</p>
<p>var crosshairTexture:Texture2D;</p>
<p>var position:Rect;</p>
<p>function Start( )</p>
<p>{</p>
<p>position=Rect((Screen .with-crosshairTexture.with)/2,(Screen.height-crosshairTexture.height)/2,crosshairTexture,crosshairTexture.height);</p>
<p>}</p>
<p>function OnGUI( )</p>
<p>{</p>
<p>Gui.DrawTexture(position,crosshairTexture);</p>
<p>}</p>
<p>首先我们设定了两个变量。第一个变量是定义我们将要用可选的方式来选择图形纹理。第二个变量定义了一个方形区间，它是图形纹理在屏幕上的位置范围。</p>
<p>在start( ) 中函数用来设定图形纹理在屏幕上的位置。函数中，有四个参数，用来定义方形区域的大小和位置。第一个参数定义了方形区域的左边框，第二个是底边框，第三和第四个参数定义了宽和高。</p>
<p>OnGUI( )函数中，使用GUI类程序来让图形显示在屏幕上。DrawTexture( )函数的参数position和crosshairTexture将使准星显示在屏幕的中央位置。</p>
<p>保存脚本。</p>
<p>创建一个新的空物体，命名为“GUI”。</p>
<p>把脚本“Crosshair”赋予给GUI物体。</p>
<p>点选GUI物体，把在文件夹Texturelaim下的欲使用的图形拖放到参数面板变量Crosshair Texture中。</p>
<p>运行游戏，屏幕中就会有准星显示了。</p>
<p>物理特效：</p>
<p>现在，我们想要游戏中的物体效果越真实越好，这是通过添加物理特效实现的。在这一节中，我们将在环境中添加一些物体，他们能被飞弹击中后有相应的反应。首先有几个新概念要解释下。</p>
<p>校正（Update）</p>
<p>先前，我们在函数Update（）中写入代码，这样可以在每一帧都执行其中的代码。其中有个例子是检测玩家点击开火键。帧速并不是一个固定值，它是根据场景复杂度等因素来定的。各帧之间的时间差会导致不稳定的物体反应。因此，如果想在场景中添加有物理反应的物体（刚体等），代码就应该写在函数FixedUpdate（）中。Unity中deltaTime的值用来测定渲染两个连续帧的所用时间。</p>
<p>一般而言，函数Update与FixedUpdate之间的区别如下：</p>
<p>Update（）-其中的代码通常用于角色行为、游戏逻辑等。这个函数中的deltaTime值并不是固定的。</p>
<p>FixedUpdate（）-其中的代码通常用于刚体物体（物理属性的行为）。函数中deltaTime的值通常是固定的。</p>
<p>FixedUpdate函数被调用的频率是主菜单中Edit-Project Settings-Time的FixedTimestep属性确定的，当然也是可以更改的。第二个属性Time Scale是读取每秒的帧速和相应的倒数值。</p>
<p>技巧：定义FixedTimestep值时，要注意把握好一个平衡：值越小，物理效果越真实越好，但影响游戏运行速度。应该同时确保游戏运行速度和物理效果的真实性。</p>
<p>最后说一下yield，它相当于暂停当前正在执行的函数。</p>
<p>回到游戏，我们想实现的效果：</p>
<p>使玩家可以发射飞弹（已经实现了）。</p>
<p>如果飞弹与其它刚体物体发生碰撞，检测其范围类是否有其它被赋予刚体属性的物体。</p>
<p>对爆炸冲击力范围内的每个刚体物体，均给予一个upwards方向上的力，使它们对飞弹产生反应。</p>
<p>让我们看看修改后的爆炸脚本（Explosion Javascript）</p>
<p>var explosionTime = 1.0;</p>
<p>var explosionRadius = 5.0;</p>
<p>var explosionPower = 2000.0;</p>
<p>function Start()</p>
<p>{</p>
<p>//Destroy the explosion in x seconds,</p>
<p>//this will give the particle system and audio enough time to finish playing</p>
<p>Destroy( gameObject, explosionTime );</p>
<p>//Find all nearby colliders</p>
<p>var colliders : Collider[] = Physics.OverlapSphere( transform.position,</p>
<p>explosionRadius );</p>
<p>首先检测下飞弹落点周围是否有带碰撞器的物体。函数Physics.OverlapSphere（）有两个参数：3D位置和半径值，然后返回一组检测到的在半径内的碰撞器的数组。</p>
<p>//Apply a force to all surrounding rigid bodies.</p>
<p>for( var hit in colliders )</p>
<p>{</p>
<p>一旦得到这些数组后，就会对每个对应碰撞器的刚体物体一个在特定方向上的力。</p>
<p>if( hit.rigidbody )</p>
<p>{</p>
<p>hit.rigidbody.AddExplosionForce( explosionPower,</p>
<p>transform.position, explosionRadius );</p>
<p>}</p>
<p>}</p>
<p>然后我们在飞弹的炸点处，向上的方向增加一个力（ExplosionPower）。但是，爆炸效果是随着距离而递减的，作用力大小不能在整个半径内都一样。圆周位置的刚体物体受到的作用力应该比炸点中心处小。函数把这种效果也考虑在内的。通过调节外部变量explosionPower和explosionRadius的值，可以较容易的得到想要的效果。</p>
<p>//If we have a particle emitter attached, emit particles for .5 seconds</p>
<p>if( particleEmitter )</p>
<p>{</p>
<p>particleEmitter.emit = true;</p>
<p>yield WaitForSeconds( 0.5 );</p>
<p>particleEmitter.emit = false;</p>
<p>}</p>
<p>}</p>
<p>如果一个粒子发射器也添加到了爆炸预制中的话，然后就开始发射粒子，0.5秒后停止发射（yield）。</p>
<p>完整爆炸脚本如下：</p>
<p>var explosionTime = 1.0;</p>
<p>var explosionRadius = 5.0;</p>
<p>var explosionPower = 2000.0;</p>
<p>function Start()</p>
<p>{</p>
<p>//Destroy the explosion in x seconds,</p>
<p>//this will give the particle system and audio enough time to finish playing</p>
<p>Destroy( gameObject, explosionTime );</p>
<p>//Find all nearby colliders</p>
<p>var colliders : Collider[] = Physics.OverlapSphere( transform.position,</p>
<p>explosionRadius );</p>
<p>//Apply a force to all surrounding rigid bodies.</p>
<p>for( var hit in colliders )</p>
<p>{</p>
<p>if( hit.rigidbody )</p>
<p>{</p>
<p>hit.rigidbody.AddExplosionForce( explosionPower,</p>
<p>transform.position, explosionRadius );</p>
<p>}</p>
<p>}</p>
<p>//If we have a particle emitter attached, emit particles for .5 seconds</p>
<p>if( particleEmitter )</p>
<p>{</p>
<p>particleEmitter.emit = true;</p>
<p>yield WaitForSeconds( 0.5 );</p>
<p>particleEmitter.emit = false;</p>
<p>}</p>
<p>}</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/14/Unity3D第一人称射击游戏（推荐）/" data-id="cis0exhko001816uoqo02ia3f" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Unity3D-游戏/">Unity3D,游戏</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android-功能开发笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/14/Android-功能开发笔记/" class="article-date">
  <time datetime="2016-05-14T14:07:29.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/14/Android-功能开发笔记/">Android_功能开发笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1，重力感应<br>感应器编程 </p>
<p> a.获取系统服务（SENSOR_SERVICE)返回一个SensorManager 对象<br>sensormanager = (SensorManager)getSystemSeriver(SENSOR_SERVICE);<br>b.通过SensorManager对象获取相应的Sensor类型的对象<br>sensorObject = sensormanager.getDefaultSensor(sensor Type);<br>c.声明一个SensorEventListener 对象用于侦听Sensor 事件，并重载onSensorChanged方法<br>SensorEventListener sensorListener = new SensorEventListener(){<br>};<br>d.注册相应的SensorService<br>sensormanager.registerListener(sensorListener, sensorObject, Sensor TYPE);<br>e.销毁相应的SensorService<br>sensormanager.unregisterListener(sensorListener, sensorObject);</p>
<p>f: SensorListener 接口是传感器应用程序的中心。它包括两个必需方法：<br>　　 onSensorChanged(int sensor,float values[]) 方法在传感器值更改时调用。<br>该方法只对受此应用程序监视的传感器调用(更多内容见下文)。该方法的参数包括：一个整数，指示更改的传感器;一个浮点值数组，表示传感器数据本身。有些传感器只提供一个数据值，另一些则提供三个浮点值。方向和加速表传感器都提供三个数据值。</p>
<p>layoutInflater = (LayoutInflater)context.getSystemService(Context.Layout_inflater_service);<br>利用上下文对象取得布局服务<br>View convertView = layoutInflater.inflate(listviewItem, null);</p>
<p>Android aidl服务通信<br>远程对象Ibender是代理对象<br>系统内部的服务也需要进行aidl实现</p>
<p>为activity应用主题需要在application里面进行添加theme</p>
<p>1,强制执行单任务模式<br>如果应用程序跳转走后再次启动的话，可能会在设备上产生多个activity的实例，会可能导致异常<br>确保设备上只有一个actuvity执行<br>android:launchMode=”singleInstance”<br>使得所有的activity作为一个任务，共享信息非常方便<br>android:lanuchMode=”sigleTask”<br>2，强制纵屏<br>android:screenOrientation=”portrait”<br>强制横屏<br>android:screenOrientation=”landscape”<br>在硬键盘滑出时，先前的情况还是会导致activity的关闭和重新启动，所以可以采用第三种办法，告知Android系统处理应用程序方向和键盘滑出事件，可以在activity元素属性中添加如下代码：<br>android:configChanges=”orientation|keyboardHidden”<br>该方法可以单独使用，也可以和screenOrdientation属性结合在一起使用，视应用程序要求而定<br>3，声音转换为文本<br>Google功能<br>RecongizerIntent<br>4，设置线程优先级<br>可以在myThread.start()前，调用myThread.setPriority(priority）为线程设置不同的优先级，这里的priority不能大于常量Thread.MAX_PRIORITY(该值为10)，也不能小于1<br>5，有时候当一个组件完成或被杀死后，开发者希望由它产生的线程也被杀死<br>方法一：mythread.interrupt()<br>方法二：mythread.setDaemon(true)将所有生成的线程声明为守护线程，这样可以确保如果应用程序的主线程被杀死，那么该应用程序的所有守护线程可也以都被杀死<br>方法三：可以在run（）方法中使用while（isRunning）并且从循环外部isRunning=false的方法来杀死线程，但是这种方法的确定是不能有效的控制线程停止的时间<br>6，倒数计时器<br>CountDownTimer<br>7,使用搜索键<br>8,使用手势<br>simpleongestureListener（）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/14/Android-功能开发笔记/" data-id="cis0exhim000116uofd41ychz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android中通过来电转移实现“电话已关机”-“此号码已停机”等" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/14/Android中通过来电转移实现“电话已关机”-“此号码已停机”等/" class="article-date">
  <time datetime="2016-05-14T14:05:41.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/14/Android中通过来电转移实现“电话已关机”-“此号码已停机”等/">Android中通过来电转移实现“电话已关机”,“此号码已停机”等</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>现在需要在Android上实现，发现360手机安全卫士for Android 也是通过来电转移实现的，尝试了下，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//13800000000即是要转移到的号码  </span><br><span class="line">Intent localIntent = new Intent();  </span><br><span class="line">localIntent.setAction(&quot;android.intent.action.CALL&quot;);  </span><br><span class="line">Uri uri = Uri.parse(&quot;tel:&quot; + &quot;**67*13800000000%23&quot;);  </span><br><span class="line">localIntent.setData(uri);  </span><br><span class="line">startActivity(localIntent);</span><br></pre></td></tr></table></figure>
<p>以下号码供参考：<br>返回空号的提示音：<strong>67#13800000000# 或者 </strong>67#13444444444#<br>返回暂时无法接通：<strong>67#13642952697#<br>返回停机的提示音：</strong>67#13701110216#<br>返回电话号码有误：<strong>67#13800516309#<br>返回电话号码关机：</strong>67#13810538911#<br>转移还有以下方式<br>1、无条件呼叫转移： 激活方式<strong>21<em>号码# , 取消方式##21# , 查询方式 </em>#21# ; ! [6 ~# a; [3 X) u” X) r8 Y4 d<br>2、 遇忙呼叫转移： 激活方式</strong>67<em>号码# , 取消方式##67# , 查询方式 </em>#67# ;<br>3、 无应答呼叫转移: 激活方式<em>*61</em>号码# , 取消方式##61# , 查询方式*#61# ; </p>
<p>4、 不可及呼叫转移: 激活方式<em>*62</em>号码# , 取消方式##62# , 查询方式 *#62# .<br>所以取消呼叫转移的代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Intent localIntent = new Intent();  </span><br><span class="line">localIntent.setAction(&quot;android.intent.action.CALL&quot;);  </span><br><span class="line">Uri uri = Uri.parse(&quot;tel:&quot; + &quot;%23%2367%23&quot;);  </span><br><span class="line">localIntent.setData(uri);  </span><br><span class="line">startActivity(localIntent);</span><br></pre></td></tr></table></figure>
<p>注意：”#” 必须用 “%23“代替<br>参考资料：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">http://www.devdiv.net/bbs/thread-31703-1-1.html</span><br><span class="line">作者：dream</span><br><span class="line">出处：http://blog.csdn.net/dream19861009/archive/2010/12/14/6076140.aspx</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/14/Android中通过来电转移实现“电话已关机”-“此号码已停机”等/" data-id="cis0exhjy000o16uofx7da6n6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android-自动接听来电" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/14/Android-自动接听来电/" class="article-date">
  <time datetime="2016-05-14T14:04:02.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/14/Android-自动接听来电/">Android_自动接听来电</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前做的程序是4.1以下的，分别用2种方式处理，即可实现自动接听电话的功能，最近到了款4.1的机子，发现自动接听不起作用了，会抛一个异常：<br>java.lang.SecurityException: Permission Denial: not allowed to send broadcast android.intent.action.HEADSET_PLUG from pid=19412, uid=10075</p>
<p>最后解决方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public void autoAnswerPhone() &#123;</span><br><span class="line">try &#123;</span><br><span class="line">Log.i(TAG,&quot;autoAnswerPhone&quot;);</span><br><span class="line">ITelephony itelephony = getITelephony();</span><br><span class="line">//itelephony.silenceRinger();</span><br><span class="line">itelephony.answerRingingCall();</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">try &#123;</span><br><span class="line">Log.e(TAG, &quot;用于Android2.3及2.3以上的版本上&quot;);</span><br><span class="line">Intent intent = new Intent(&quot;android.intent.action.MEDIA_BUTTON&quot;);</span><br><span class="line">KeyEvent keyEvent = new KeyEvent(KeyEvent.ACTION_DOWN, KeyEvent.KEYCODE_HEADSETHOOK);</span><br><span class="line">intent.putExtra(&quot;android.intent.extra.KEY_EVENT&quot;,keyEvent);</span><br><span class="line">sendOrderedBroadcast(intent,&quot;android.permission.CALL_PRIVILEGED&quot;);</span><br><span class="line">intent = new Intent(&quot;android.intent.action.MEDIA_BUTTON&quot;);</span><br><span class="line">keyEvent = new KeyEvent(KeyEvent.ACTION_UP, KeyEvent.KEYCODE_HEADSETHOOK);</span><br><span class="line">intent.putExtra(&quot;android.intent.extra.KEY_EVENT&quot;,keyEvent);</span><br><span class="line">sendOrderedBroadcast(intent,&quot;android.permission.CALL_PRIVILEGED&quot;);</span><br><span class="line">Intent localIntent1 = new Intent(Intent.ACTION_HEADSET_PLUG);</span><br><span class="line">localIntent1.addFlags(Intent.FLAG_ACTIVITY_NO_HISTORY);</span><br><span class="line">localIntent1.putExtra(&quot;state&quot;, 1);</span><br><span class="line">localIntent1.putExtra(&quot;microphone&quot;, 1);</span><br><span class="line">localIntent1.putExtra(&quot;name&quot;, &quot;Headset&quot;);</span><br><span class="line">sendOrderedBroadcast(localIntent1,</span><br><span class="line">&quot;android.permission.CALL_PRIVILEGED&quot;);</span><br><span class="line">Intent localIntent2 = new Intent(Intent.ACTION_MEDIA_BUTTON);</span><br><span class="line">KeyEvent localKeyEvent1 = new KeyEvent(KeyEvent.ACTION_DOWN,</span><br><span class="line">KeyEvent.KEYCODE_HEADSETHOOK);</span><br><span class="line">localIntent2.putExtra(&quot;android.intent.extra.KEY_EVENT&quot;,</span><br><span class="line">localKeyEvent1);</span><br><span class="line">sendOrderedBroadcast(localIntent2,</span><br><span class="line">&quot;android.permission.CALL_PRIVILEGED&quot;);</span><br><span class="line">Intent localIntent3 = new Intent(Intent.ACTION_MEDIA_BUTTON);</span><br><span class="line">KeyEvent localKeyEvent2 = new KeyEvent(KeyEvent.ACTION_UP,</span><br><span class="line">KeyEvent.KEYCODE_HEADSETHOOK);</span><br><span class="line">localIntent3.putExtra(&quot;android.intent.extra.KEY_EVENT&quot;,</span><br><span class="line">localKeyEvent2);</span><br><span class="line">sendOrderedBroadcast(localIntent3,</span><br><span class="line">&quot;android.permission.CALL_PRIVILEGED&quot;);</span><br><span class="line">Intent localIntent4 = new Intent(Intent.ACTION_HEADSET_PLUG);</span><br><span class="line">localIntent4.addFlags(Intent.FLAG_ACTIVITY_NO_HISTORY);</span><br><span class="line">localIntent4.putExtra(&quot;state&quot;, 0);</span><br><span class="line">localIntent4.putExtra(&quot;microphone&quot;, 1);</span><br><span class="line">localIntent4.putExtra(&quot;name&quot;, &quot;Headset&quot;);</span><br><span class="line">sendOrderedBroadcast(localIntent4,</span><br><span class="line">&quot;android.permission.CALL_PRIVILEGED&quot;);</span><br><span class="line">&#125; catch (Exception e2) &#123;</span><br><span class="line">e2.printStackTrace();</span><br><span class="line">Intent meidaButtonIntent = new Intent(Intent.ACTION_MEDIA_BUTTON); </span><br><span class="line">          KeyEvent keyEvent = new KeyEvent(KeyEvent.ACTION_UP, KeyEvent.KEYCODE_HEADSETHOOK); </span><br><span class="line">          meidaButtonIntent.putExtra(Intent.EXTRA_KEY_EVENT,keyEvent); </span><br><span class="line">          sendOrderedBroadcast(meidaButtonIntent, null);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/14/Android-自动接听来电/" data-id="cis0exhjb000916uorfwjs0ww" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android_消息推送" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/14/Android_消息推送/" class="article-date">
  <time datetime="2016-05-14T13:26:18.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/14/Android_消息推送/">Android 消息推送</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1.引言</p>
<p>　　所谓的消息推送就是从服务器端向移动终端发送连接，传输一定的信息。比如一些新闻客户端，每隔一段时间收到一条或者多条通知，这就是从服务器端传来的推送消息；还比如常用的一些IM软件如微信、GTalk等，都具有服务器推送功能。</p>
<p>　　推送方法如下：</p>
<p>　　1)通过SMS进行服务器端和客户端的交流通信。</p>
<p>　　在Android平台上，你可以通过拦截SMS消息并且解析消息内容来了解服务器的意图，可以实现完全的实时操作。但是问题是这个方案的成本相对比较高，且依赖于运营商。</p>
<p>　　2)循环主动定时获取</p>
<p>　　这种方法需要客户端来做一个定时或者周期性的访问服务器端接口，以获得最新的消息。轮询的频率太慢可能导致某些消息的延迟，太快则会大量消耗网络带宽和电池。</p>
<p>　　3)持久连接</p>
<p>　　这个方案可以解决由轮询带来的性能问题，但是还是会消耗手机的电池。我们需要开一个服务来保持和服务器端的持久连接（苹果就和谷歌的C2DM是这种机制）。但是对于Android系统，当系统可用资源较低，系统会强制关闭我们的服务或者是应用，这种情况下连接会强制中断。（Apple的推送服务之所以工作的很好，是因为每一台手机仅仅保持一个与服务器之间的连接，事实上C2DM也是这么工作的。即所有的推送服务都是经由一个代理服务器完成的，这种情况下只需要和一台服务器保持持久连接即可。C2DM=Cloud to Device Messaging）。</p>
<p>　　相比之下第三种还是最可行的。为软件编写系统服务或开机启动功能；或者如果系统资源较低，服务被关闭后可以在onDestroy ()方法里面再重启该服务，进而实现持久连接的方式。</p>
<p>　　C2DM内置于Android的2.2系统上，无法兼容老的1.6到2.1系统；且依赖于Google官方提供的C2DM服务器，由于国内的网络环境，这个服务经常不可用。</p>
<p>　　建立在TCP协议之上的XMPP协议，不仅可提供可这种持久连接的功能，能实现服务器和客户机的双工通信，还能不依赖与系统版本和google服务器的限制，提供了比较好的解决方案。</p>
<ol>
<li>XMPP协议</li>
</ol>
<p>　　XMPP全称Extensible Messaging and Presence Protocol，前身是Jabber项目，是一种以XML为基础的开放式即时通讯协议。XMPP因为被Google Talk和网易泡泡应用而被广大网民所接触。XMPP的关键特色是，分散式的即时通讯系统，以及使用XML串流。XMPP目前被IETF国际标准组织完成了标准化工作。</p>
<p>　　Android push notification(androidpn) 是一个基于XMPP协议的java开源实现，它包含了完整的客户端和服务器端。该服务器端基本是在另外一个开源工程openfire基础上修改实现的。</p>
<p>　　androidpn客户端需要用到一个基于java的开源XMPP协议包asmack，这个包同样也是基于openfire下的另外一个开源项目smack，不过我们不需要自己编译，可以直接把androidpn客户端里面的asmack.jar拿来使用。客户端利用asmack中提供的XMPPConnection类与服务器建立持久连接，并通过该连接进行用户注册和登录认证，同样也是通过这条连接，接收服务器发送的通知。</p>
<p>　　androidpn服务器端也是java语言实现的，基于openfire开源工程，不过它的Web部分采用的是spring框架，这一点与openfire是不同的。Androidpn服务器包含两个部分，一个是侦听在5222端口上的XMPP服务，负责与客户端的XMPPConnection类进行通信，作用是用户注册和身份认证，并发送推送通知消息。另外一部分是Web服务器，采用一个轻量级的HTTP服务器，负责接收用户的Web请求。服务器的这两方式，意义非凡：当相应的TCP端口被防火墙封闭，可以使用轮询的方式进行访问，因此又有助于通过防火墙。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/14/Android_消息推送/" data-id="cis0exhk2000s16uo0eceo3yt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android_条码扫描二维码扫描" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/14/Android_条码扫描二维码扫描/" class="article-date">
  <time datetime="2016-05-14T13:26:18.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/14/Android_条码扫描二维码扫描/">Android_条码扫描二维码</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>前言<br>　　最近公司的Android项目需要用到摄像头做条码或二维码的扫描，Google一下，发现一个以Apache License 2.0 开源的 ZXing项目。Zxing项目里的Android实现太过复杂多余东西太多，得对其进行简化。</p>
<p>前提条件<br>　　下载源代码：点击这里</p>
<p>　　编译核心库：Zxing的主页上有介绍具体步骤，大家也可以参照这篇博文：android 条码识别软件开发全解析(续2详解绝杀！)</p>
<p>导入项目<br>　　打开Eclipse 导入 源码中的 Android 项目，然后右击项目 选择“Build path”——》”Add External Archives” 把核心库 core.jar文件加入到项目中。</p>
<p>此时编译一下项目，会发现报错,“ Multiple substitutions specified in non-positional format; did you mean to add the formatted=”false” attribute?”之类的。打开raw 下的Values 发现错误是在一个<string>上。这里把 “preferences_custom_product_search_summary” 里的  %s  %f  全部都改成  %1$s  %1$f（因为我们用不到多国语言，建议只保留默认的Value ，其他全部删除）。</string></p>
<p>　　原因：由于新的SDK采用了新版本的aapt（Android项目编译器），这个版本的aapt编译起来会比老版本更加的严格，然后在Android最新的开发文档的描述String的部分，已经说明如何去设置 %s 等符号</p>
<p>　　“If you need to format your strings using String.format(String, Object…) , then you can do so by putting your format arguments in the string resource. For example, with the following resource:</p>
<p>　　<string name="welcome_messages">Hello, %1$s! You have %2$d new messages.</string></p>
<p>　　In this example, the format string has two arguments: %1$s is a string and %2$d is a decimal number. You can format the string with arguements from your application…“</p>
<p>　　经过以上步骤后项目应该就可以运行了。</p>
<p>　　但是ZXing的android项目东西太多了，有很多是我们不需要的，得新建另一个项目简化它。</p>
<p>简化<br>　　在开始前大致介绍一下简化ZXing需要用到各个包 、类的职责。</p>
<p>CaptureActivity。这个是启动Activity 也就是扫描器（如果是第一安装，它还会跳转到帮助界面）。<br>CaptureActivityHandler 解码处理类，负责调用另外的线程进行解码。<br>DecodeThread 解码的线程。<br>com.google.zxing.client.android.camera 包，摄像头控制包。<br>ViewfinderView 自定义的View，就是我们看见的拍摄时中间的框框了。<br>新建另一个项目<br>　　新建另一个项目将启动的Activity命名为CaptureActivity，并导入核心库。项目新建完成后我们打开 CaptureActivity 的布局文件，我这里为main。把里面的XML修改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">复制代码</span><br><span class="line">1 &lt;FrameLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">2 android:layout_width=&quot;fill_parent&quot; android:layout_height=&quot;fill_parent&quot;&gt;</span><br><span class="line">3 &lt;SurfaceView android:id=&quot;@+id/preview_view&quot;</span><br><span class="line">4 android:layout_width=&quot;fill_parent&quot; android:layout_height=&quot;fill_parent&quot;</span><br><span class="line">5 android:layout_centerInParent=&quot;true&quot;/&gt;</span><br><span class="line">6 </span><br><span class="line">7 &lt;com.Zxing.Demo.view.ViewfinderView</span><br><span class="line">8 android:id=&quot;@+id/viewfinder_view&quot; android:layout_width=&quot;fill_parent&quot;</span><br><span class="line">9 android:layout_height=&quot;fill_parent&quot; android:background=&quot;@android:color/transparent&quot;/&gt;</span><br><span class="line">10 &lt;TextView android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">11 android:id=&quot;@+id/txtResult&quot;</span><br><span class="line">12 android:layout_height=&quot;wrap_content&quot; android:text=&quot;@string/hello&quot;/&gt;</span><br><span class="line">13 </span><br><span class="line">14  &lt;/FrameLayout&gt;</span><br></pre></td></tr></table></figure>
<p>复制代码<br>　　可以看到在XML里面用到了 ViewfinderView 自定义view 。所以新建一个View 的包，然后把：ViewfinderView 和 ViewfinderResultPointCallback 靠到里面（记得对应修改XML里面的包）。</p>
<p>打开 CaptureActivity 覆盖 onCreate 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">复制代码</span><br><span class="line">1 @Override</span><br><span class="line">2 publicvoid onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">3 super.onCreate(savedInstanceState);</span><br><span class="line">4 setContentView(R.layout.main);</span><br><span class="line">5 //初始化 CameraManager</span><br><span class="line">6   CameraManager.init(getApplication());</span><br><span class="line">7 </span><br><span class="line">8 viewfinderView = (ViewfinderView) findViewById(R.id.viewfinder_view);</span><br><span class="line">9 txtResult = (TextView) findViewById(R.id.txtResult);</span><br><span class="line">10 hasSurface =false;</span><br><span class="line">11 inactivityTimer =new InactivityTimer(this);</span><br><span class="line">12 &#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>  这里调用到的 CameraManager 类是控制摄像头的包里的类。新建一个camera包把：com.google.zxing.client.android.camera 里面的类全部拷入，另外我把PlanarYUVLuminanceSource也拷入到这个包里面。根据错误的提示来修正代码，主要是修改正包结构。（整个简化的流程都是如此：“根据错误提示，修改代码”）。</p>
<p>　　在修改的过程中，有很多是关于R 资源的问题，在此我们需要将Values  里面的两个xml资源文件拷入项目中：colos.xml 和ids.xml 。 ctrl+b 一下看看error 是不是少了很多。在CameraManager中有些地方需要用到项目的配置，这里需要把配置直接写入代码中：<br>　　<br>　　<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">　　</span><br><span class="line"></span><br><span class="line">// SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);</span><br><span class="line">//是否使用前灯</span><br><span class="line">// if (prefs.getBoolean(PreferencesActivity.KEY_FRONT_LIGHT, false)) &#123;</span><br><span class="line">// FlashlightManager.enableFlashlight();</span><br><span class="line">// &#125;</span><br><span class="line">FlashlightManager.enableFlashlight();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 　　使用摄像头需要加入相应的权限：</span><br></pre></td></tr></table></figure></p>
<p><uses-permission android:name="android.permission.CAMERA"></uses-permission></p>
<p><uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"></uses-permission></p>
<p><uses-feature android:name="android.hardware.camera"></uses-feature></p>
<p><uses-feature android:name="android.hardware.camera.autofocus"></uses-feature></p>
<p><uses-permission android:name="android.permission.VIBRATE"></uses-permission></p>
<uses-permission android:name="android.permission.FLASHLIGHT">

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">　　当View 和 camera 包里的错误修正完成后，我们继续来看CaptureActivity。</span><br><span class="line"></span><br><span class="line">覆盖onResume方法初始化摄像头：</span><br></pre></td></tr></table></figure>
<p>复制代码<br>@Override<br>protectedvoid onResume() {<br>super.onResume();<br>SurfaceView surfaceView = (SurfaceView) findViewById(R.id.preview_view);<br>SurfaceHolder surfaceHolder = surfaceView.getHolder();<br>if (hasSurface) {<br>initCamera(surfaceHolder);<br>} else {<br>surfaceHolder.addCallback(this);<br>surfaceHolder.setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);<br>}<br>decodeFormats =null;<br>characterSet =null;</p>
<p>playBeep =true;<br>AudioManager audioService = (AudioManager) getSystemService(AUDIO_SERVICE);<br>if (audioService.getRingerMode() != AudioManager.RINGER_MODE_NORMAL) {<br>playBeep =false;<br>}<br>initBeepSound();<br>vibrate =true;<br>}</p>
<p>复制代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">initCamera</span><br><span class="line">SurfaceHolder接口实现</span><br><span class="line">initCamera () 方法用于初始化摄像头，如果排除了所有的error ，运行项目时就可以看到大致扫描界面了。 surfaceHolder.addCallback(this);表示让CaptureActivity实现其callback接口。</span><br><span class="line"></span><br><span class="line">handler = new CaptureActivityHandler(this, decodeFormats,characterSet) 用于进行扫描解码处理。</span><br><span class="line"></span><br><span class="line">解码</span><br><span class="line">　　上面的步骤主要都是用于对摄像头的控制，而解码的真正工作入口是在CaptureActivityHandler 里面的。新建一个Decoding包把以下文件拷入包中：</span><br><span class="line"></span><br><span class="line">CaptureActivityHandler</span><br><span class="line">DecodeFormatManager</span><br><span class="line">DecodeHandler</span><br><span class="line">DecodeThread</span><br><span class="line">FinishListener</span><br><span class="line">InactivityTimer</span><br><span class="line">Intents</span><br><span class="line">由于我们的包结构和Zxing 项目的有所不同所以需要注意一下类的可访问性</span><br><span class="line"></span><br><span class="line">同样开始ctrl+B 编译一下，然后开始修正错误。</span><br><span class="line"></span><br><span class="line">　　在CaptureActivityHandler 里 把 handleMessage 里的部分方法先注释掉如：“decode_succeeded ”分支，这是解码成功时调用 CaptureActivity 展示解码的结果。</span><br><span class="line"></span><br><span class="line">在DecodeThread 类里，修改部分涉及Preference配置的代码：</span><br></pre></td></tr></table></figure>
<p>复制代码<br>DecodeThread(CaptureActivity activity,<br>Vector<barcodeformat> decodeFormats,<br>String characterSet,<br>ResultPointCallback resultPointCallback) {</barcodeformat></p>
<p>this.activity = activity;<br>handlerInitLatch =new CountDownLatch(1);</p>
<p>hints =new Hashtable<decodehinttype, object="">(3);</decodehinttype,></p>
<p>//// The prefs can’t change while the thread is running, so pick them up once here.<br>// if (decodeFormats == null || decodeFormats.isEmpty()) {<br>// SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(activity);<br>// decodeFormats = new Vector<barcodeformat>();<br>// if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_1D, true)) {<br>// decodeFormats.addAll(DecodeFormatManager.ONE_D_FORMATS);<br>// }<br>// if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_QR, true)) {<br>// decodeFormats.addAll(DecodeFormatManager.QR_CODE_FORMATS);<br>// }<br>// if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_DATA_MATRIX, true)) {<br>// decodeFormats.addAll(DecodeFormatManager.DATA_MATRIX_FORMATS);<br>// }<br>// }<br>if (decodeFormats ==null|| decodeFormats.isEmpty()) {<br>decodeFormats =new Vector<barcodeformat>();<br>decodeFormats.addAll(DecodeFormatManager.ONE_D_FORMATS);<br>decodeFormats.addAll(DecodeFormatManager.QR_CODE_FORMATS);<br>decodeFormats.addAll(DecodeFormatManager.DATA_MATRIX_FORMATS);</barcodeformat></barcodeformat></p>
<p>}</p>
<p>hints.put(DecodeHintType.POSSIBLE_FORMATS, decodeFormats);</p>
<p>if (characterSet !=null) {<br>hints.put(DecodeHintType.CHARACTER_SET, characterSet);<br>}</p>
<p>hints.put(DecodeHintType.NEED_RESULT_POINT_CALLBACK, resultPointCallback);<br>}<br>复制代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">这里是设置 解码的类型，我们现在默认将所有类型都加入。</span><br><span class="line"></span><br><span class="line">错误类型基本上都是：包结构、PreferencesActivity 的配置 、类可访问性的问题。根据错误提示耐心把错误解决。</span><br><span class="line"></span><br><span class="line">返回解码结果</span><br><span class="line"> 　　还记得在 CaptureActivityHandler 的 messagehandler 里注销掉的Case分支吗？现在CaptureActivity 里实现它。</span><br></pre></td></tr></table></figure>
<p>复制代码<br>publicvoid handleDecode(Result obj, Bitmap barcode) {<br>inactivityTimer.onActivity();<br>viewfinderView.drawResultBitmap(barcode);<br>playBeepSoundAndVibrate();<br>txtResult.setText(obj.getBarcodeFormat().toString() +”:”</p>
<ul>
<li>obj.getText());<br>}<br>```<br>复制代码<br>最后<br>　　ZXing的简化已基本完成，有几位是可以运行成功的？呵呵。</li>
</ul>
<p>下面是CaptureActivity的源码:</p>
<p>CaputreActivity<br>简化过的包结构图：</p>
<p>　</p>
<p>　简化后的ZXing 更加方便我们了解ZXing项目 是如何解码的。只要仔细查看源码，进行单点跟踪调试，相信大家很容易能理解。</p>
<p>顾客是上帝<br>   很多人留言要源码， 其实我这不是什么源码，我只是把ZXing的东西简化了一下而已。事实上我也不喜欢直接放源码项目，这样大家就不想读ZXing的源码了。</p>
<p>下面是我简化的版本：Zxing简化</p>
<p>很多人需要Core 核心包（其实ZXing的源码里面就有），这里提供下我写文章时的版本 1.6的：</p>
<p>Zxing</p>
</uses-permission>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/14/Android_条码扫描二维码扫描/" data-id="cis0exhk6000u16uoq9o5753h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Json_反序列化" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/14/Json_反序列化/" class="article-date">
  <time datetime="2016-05-14T13:26:18.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/14/Json_反序列化/">Json反序列化</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <pre><code>  /**
 * 由字符串反序列化成实体类  针对的是一个实体，此实体中的属性不包括自定义的类型，如Teacher类型，或者List&lt;Teacher&gt;类型 
 * @param source 传入json中的字符串
 * @param beanClass 实体类的类型
 * @return 实体类
 */
public static Object getObjFromJsonArrStr(String source,Class beanClass)
{
    JSONObject jsonObject = (JSONObject) JSONSerializer.toJSON(source);
    return  JSONObject.toBean(jsonObject,beanClass);       
}
/**
 * 由字符串反序列化成实体类  针对的是一个实体，此实体中的属性包括自定义的类型，如Teacher类型，或者List&lt;Teacher&gt;类型
 * @param jsonArrStr
 * @param clazz
 * @param classMap
 * @return
 */
public static Object getObjFromJsonArrStr(String jsonArrStr, Class clazz, Map classMap) 
{ 
    JSONObject jsonObj = JSONObject.fromObject(jsonArrStr);  
            return JSONObject.toBean(jsonObj, clazz, classMap);            
}


/**
 * 将string转换成listBean
 * @param jsonArrStr 需要反序列化的字符串
 * @param clazz 被反序列化之后的类
 * @return 实体list
 */
@SuppressWarnings(&quot;unchecked&quot;)
public static List getListFromJsonArrStr(String jsonArrStr, Class clazz) {  
    JSONArray jsonArr = JSONArray.fromObject(jsonArrStr);  
    List list = new ArrayList(); 
    for (int i = 0; i &lt; jsonArr.size(); i++) 
    { 
        list.add(JSONObject.toBean(jsonArr.getJSONObject(i), clazz));  
    } 
    return list; 
}

/**
 * 将string转换成listBean 属性中包含实体类等 如List&lt;Student&gt; 而Student中含有属性List&lt;Teacher&gt;
 * @param jsonArrStr 需要反序列化的字符串
 * @param clazz 反序列化后的类
 * @param classMap 将属性中包含的如Teacher加入到一个Map中，格式如map.put(&quot;teacher&quot;,Teacher.class)
 * @return 反序列化后的字符串
 * 使用示例：
    Map classMap = new HashMap();
    //必须要对Parent进行初始化 否则不识别
    Teacher p = new Teacher();
    classMap.put(&quot;teacher&quot;, p.getClass());
    List mlist = JSONTransfer.getListFromJsonArrStr(resultStr, Student.class, classMap);
 */
@SuppressWarnings(&quot;unchecked&quot;)
public static List getListFromJsonArrStr(String jsonArrStr, Class clazz, Map classMap) 
{ 
   JSONArray jsonArr = JSONArray.fromObject(jsonArrStr);  
   List list = new ArrayList(); 
   for (int i = 0; i &lt; jsonArr.size(); i++) 
   {          
       list.add(JSONObject.toBean(jsonArr.getJSONObject(i), clazz, classMap));  
   } 
   return list; 
}

/**
 * 序列化操作，无论是单个的对象，还是list，抑或是list中的属性仍包含list，都可以直接序列化成String类型
 * @param obj 需要被序列化的对象
 * @return 序列化之后的字符串
 */
@SuppressWarnings(&quot;unchecked&quot;)
public static String getJsonArrStrFromList(Object obj) 
{
    //返回結果
    String jsonStr = null; 
    //判空
    if (obj == null) {  
        return &quot;{}&quot;; 
    } 
    //Json配置     
    JsonConfig jsonCfg = new JsonConfig(); 

    //注册日期处理器 
    jsonCfg.registerJsonValueProcessor(java.util.Date.class, 
            new JsonDateValueProcessor(SystemConstants.DateFormat)); 

    //判断是否是list
    if (objinstanceof Collection || obj instanceof Object[]) {  
        jsonStr = JSONArray.fromObject(obj, jsonCfg).toString();  
    }else { 
        jsonStr = JSONObject.fromObject(obj, jsonCfg).toString();  
    }    
    return jsonStr;
}
</code></pre><p>关于Java序列化，ITEye上有一篇讨论的帖子比较好</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;http://www.iteye.com/topic/14707&quot;&gt;http://www.iteye.com/topic/14707&lt;/a&gt;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/14/Json_反序列化/" data-id="cis0exhks001c16uoc8mgyg5c" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android_检查是否联网" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/14/Android_检查是否联网/" class="article-date">
  <time datetime="2016-05-14T13:26:18.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/14/Android_检查是否联网/">Android_检查是否联网</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>检查是否联网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public static boolean isNetworkAvailable(Activity mActivity) &#123;</span><br><span class="line"> Context context = mActivity.getApplicationContext();</span><br><span class="line"> ConnectivityManager connectivity = (ConnectivityManager) context</span><br><span class="line">   .getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line"> if (connectivity == null) &#123;</span><br><span class="line">  return false;</span><br><span class="line"> &#125; else &#123;</span><br><span class="line">  NetworkInfo[] info = connectivity.getAllNetworkInfo();</span><br><span class="line">  if (info != null) &#123;</span><br><span class="line">   for (int i = 0; i &lt; info.length; i++) &#123;</span><br><span class="line">    if (info[i].getState() == NetworkInfo.State.CONNECTED) &#123;</span><br><span class="line">     return true;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void HttpTest(final Activity mActivity) &#123;</span><br><span class="line"> if (!isNetworkAvailable(mActivity)) &#123;</span><br><span class="line">  showToast(mActivity);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void showToast(Activity mActivity) &#123;</span><br><span class="line"> Vibrator mVibrator01 = (Vibrator) mActivity.getApplication()</span><br><span class="line">   .getSystemService(Service.VIBRATOR_SERVICE);</span><br><span class="line"> mVibrator01.vibrate(new long[] &#123; 100, 10, 100, 1000 &#125;, -1);</span><br><span class="line"> Toast.makeText(mActivity, &quot;请检查是否联网&quot;, 500).show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中还要加上手机震动和联网的权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot;/&gt; </span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.VIBRATE&quot;/&gt;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/14/Android_检查是否联网/" data-id="cis0exhjk000e16uokztf01vv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android_Afinal框架" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/14/Android_Afinal框架/" class="article-date">
  <time datetime="2016-05-14T13:26:18.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/14/Android_Afinal框架/">Android_Afinal框架</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Afinal简介<br>Afinal是一个android的ioc，orm框架，内置了四大模块功能：FinalAcitivity,FinalBitmap,FinalDb,FinalHttp。通过finalActivity，我们可以通过注解的方式进行绑定ui和事件。通过finalBitmap，我们可以方便的加载bitmap图片，而无需考虑oom等问题。通过finalDB模块，我们一行代码就可以对android的sqlite数据库进行增删改查。通过FinalHttp模块，我们可以以ajax形式请求http数据。详情请通过以下网址查看。 — More…</p>
<p>Afinal 是一个android的sqlite orm 和 ioc 框架。同时封装了android中的http框架，使其更加简单易用；<br>使用finalBitmap，无需考虑bitmap在android中加载的时候oom的问题和快速滑动的时候图片加载位置错位等问题。<br>Afinal的宗旨是简洁，快速。约定大于配置的方式。尽量一行代码完成所有事情。<br>目前Afinal主要有四大模块：</p>
<p>FinalDB模块：android中的orm框架，一行代码就可以进行增删改查。支持一对多，多对一等查询。</p>
<p>FinalActivity模块：android中的ioc框架，完全注解方式就可以进行UI绑定和事件绑定。无需findViewById和setClickListener等。</p>
<p>FinalHttp模块：通过httpclient进行封装http数据请求，支持ajax方式加载。</p>
<p>FinalBitmap模块：通过FinalBitmap，imageview加载bitmap的时候无需考虑bitmap加载过程中出现的oom和android容器快速滑动时候出现的图片错位等现象。FinalBitmap可以配置线程加载线程数量，缓存大小，缓存路径，加载显示动画等。FinalBitmap的内存管理使用lru算法，没有使用弱引用（android2.3以后google已经不建议使用弱引用，android2.3后强行回收软引用和弱引用，详情查看android官方文档），更好的管理bitmap内存。FinalBitmap可以自定义下载器，用来扩展其他协议显示网络图片，比如ftp等。同时可以自定义bitmap显示器，在imageview显示图片的时候播放动画等（默认是渐变动画显示）。</p>
<p>使用afinal快速开发框架需要有以下权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;</span><br><span class="line">2</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot; /&gt;</span><br></pre></td></tr></table></figure>
<p>第一个是访问网络<br>第二个是访问sdcard<br>访问网络是请求网络图片的时候需要或者是http数据请求时候需要，访问sdcard是图片缓存的需要。<br>FinalDB使用方法</p>
<p>关于finalDb的更多介绍，请点击这里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1</span><br><span class="line">FinalDb db = FinalDb.create(this);</span><br><span class="line">2</span><br><span class="line">User user = new User(); //这里需要注意的是User对象必须有id属性，或者有通过@ID注解的属性</span><br><span class="line">3</span><br><span class="line">user.setEmail(&quot;mail@tsz.net&quot;);</span><br><span class="line">4</span><br><span class="line">user.setName(&quot;michael yang&quot;);</span><br><span class="line">5</span><br><span class="line">db.save(user);</span><br><span class="line">FinalActivity使用方法：</span><br></pre></td></tr></table></figure>
<p>完全注解方式就可以进行UI绑定和事件绑定<br>无需findViewById和setClickListener等<br>01<br>public class AfinalDemoActivity extends FinalActivity {<br>02</p>
<p>03<br>    //无需调用findViewById和setOnclickListener等<br>04<br>    @ViewInject(id=R.id.button,click=”btnClick”) Button button;<br>05<br>    @ViewInject(id=R.id.textView) TextView textView;<br>06</p>
<p>07<br>    public void onCreate(Bundle savedInstanceState) {<br>08<br>       super.onCreate(savedInstanceState);<br>09<br>       setContentView(R.layout.main);<br>10<br>    }<br>11</p>
<p>12<br>    public void btnClick(View v){<br>13<br>       textView.setText(“text set form button”);<br>14<br>    }<br>15<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">FinalHttp使用方法：</span><br><span class="line"></span><br><span class="line">普通get方法</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">01</span><br><span class="line">FinalHttp fh = new FinalHttp();</span><br><span class="line">02</span><br><span class="line">fh.get(&quot;http://www.yangfuhai.com&quot;, new AjaxCallBack()&#123;</span><br><span class="line">03</span><br><span class="line"></span><br><span class="line">04</span><br><span class="line">    @Override</span><br><span class="line">05</span><br><span class="line">    public void onLoading(long count, long current) &#123; //每1秒钟自动被回调一次</span><br><span class="line">06</span><br><span class="line">            textView.setText(current+&quot;/&quot;+count);</span><br><span class="line">07</span><br><span class="line">    &#125;</span><br><span class="line">08</span><br><span class="line"></span><br><span class="line">09</span><br><span class="line">    @Override</span><br><span class="line">10</span><br><span class="line">    public void onSuccess(String t) &#123;</span><br><span class="line">11</span><br><span class="line">            textView.setText(t==null?&quot;null&quot;:t);</span><br><span class="line">12</span><br><span class="line">    &#125;</span><br><span class="line">13</span><br><span class="line"></span><br><span class="line">14</span><br><span class="line">    @Override</span><br><span class="line">15</span><br><span class="line">    public void onStart() &#123;</span><br><span class="line">16</span><br><span class="line">        //开始http请求的时候回调</span><br><span class="line">17</span><br><span class="line">    &#125;</span><br><span class="line">18</span><br><span class="line"></span><br><span class="line">19</span><br><span class="line">    @Override</span><br><span class="line">20</span><br><span class="line">    public void onFailure(Throwable t, String strMsg) &#123;</span><br><span class="line">21</span><br><span class="line">        //加载失败的时候回调</span><br><span class="line">22</span><br><span class="line">    &#125;</span><br><span class="line">23</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>使用FinalHttp上传文件 或者 提交数据 到服务器（post方法）</p>
<p>文件上传到服务器，服务器如何接收，请查看这里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">01</span><br><span class="line">AjaxParams params = new AjaxParams();</span><br><span class="line">02</span><br><span class="line">  params.put(&quot;username&quot;, &quot;michael yang&quot;);</span><br><span class="line">03</span><br><span class="line">  params.put(&quot;password&quot;, &quot;123456&quot;);</span><br><span class="line">04</span><br><span class="line">  params.put(&quot;email&quot;, &quot;test@tsz.net&quot;);</span><br><span class="line">05</span><br><span class="line">  params.put(&quot;profile_picture&quot;, new File(&quot;/mnt/sdcard/pic.jpg&quot;)); // 上传文件</span><br><span class="line">06</span><br><span class="line">  params.put(&quot;profile_picture2&quot;, inputStream); // 上传数据流</span><br><span class="line">07</span><br><span class="line">  params.put(&quot;profile_picture3&quot;, new ByteArrayInputStream(bytes)); // 提交字节流</span><br><span class="line">08</span><br><span class="line"></span><br><span class="line">09</span><br><span class="line">  FinalHttp fh = new FinalHttp();</span><br><span class="line">10</span><br><span class="line">  fh.post(&quot;http://www.yangfuhai.com&quot;, params, new AjaxCallBack()&#123;</span><br><span class="line">11</span><br><span class="line">        @Override</span><br><span class="line">12</span><br><span class="line">        public void onLoading(long count, long current) &#123;</span><br><span class="line">13</span><br><span class="line">                textView.setText(current+&quot;/&quot;+count);</span><br><span class="line">14</span><br><span class="line">        &#125;</span><br><span class="line">15</span><br><span class="line"></span><br><span class="line">16</span><br><span class="line">        @Override</span><br><span class="line">17</span><br><span class="line">        public void onSuccess(String t) &#123;</span><br><span class="line">18</span><br><span class="line">            textView.setText(t==null?&quot;null&quot;:t);</span><br><span class="line">19</span><br><span class="line">        &#125;</span><br><span class="line">20</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>使用FinalHttp下载文件：</p>
<p>支持断点续传，随时停止下载任务 或者 开始任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">01</span><br><span class="line">FinalHttp fh = newFinalHttp(); </span><br><span class="line">02</span><br><span class="line">    //调用download方法开始下载</span><br><span class="line">03</span><br><span class="line">    HttpHandler handler = fh.download(&quot;http://www.xxx.com/下载路径/xxx.apk&quot;, //这里是下载的路径</span><br><span class="line">04</span><br><span class="line">    true,//true:断点续传 false:不断点续传（全新下载）</span><br><span class="line">05</span><br><span class="line">    &quot;/mnt/sdcard/testapk.apk&quot;, //这是保存到本地的路径</span><br><span class="line">06</span><br><span class="line">    newAjaxCallBack() &#123; </span><br><span class="line">07</span><br><span class="line">                @Override </span><br><span class="line">08</span><br><span class="line">                public void onLoading(long count, longcurrent) &#123; </span><br><span class="line">09</span><br><span class="line">                     textView.setText(&quot;下载进度：&quot;+current+&quot;/&quot;+count); </span><br><span class="line">10</span><br><span class="line">                &#125; </span><br><span class="line">11</span><br><span class="line"></span><br><span class="line">12</span><br><span class="line">                @Override </span><br><span class="line">13</span><br><span class="line">                public voidonSuccess(File t) &#123; </span><br><span class="line">14</span><br><span class="line">                    textView.setText(t==null?&quot;null&quot;:t.getAbsoluteFile().toString()); </span><br><span class="line">15</span><br><span class="line">                &#125; </span><br><span class="line">16</span><br><span class="line"></span><br><span class="line">17</span><br><span class="line">            &#125;); </span><br><span class="line">18</span><br><span class="line"></span><br><span class="line">19</span><br><span class="line"></span><br><span class="line">20</span><br><span class="line">   //调用stop()方法停止下载</span><br><span class="line">21</span><br><span class="line">   handler.stop();</span><br></pre></td></tr></table></figure>
<p>FinalBitmap 使用方法</p>
<p>加载网络图片就一行代码 fb.display(imageView,url) ,更多的display重载请看帮助文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">view sourceprint?</span><br><span class="line">01</span><br><span class="line">private GridView gridView;</span><br><span class="line">02</span><br><span class="line">    private FinalBitmap fb;</span><br><span class="line">03</span><br><span class="line">    @Override</span><br><span class="line">04</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">05</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">06</span><br><span class="line">        setContentView(R.layout.images);</span><br><span class="line">07</span><br><span class="line"></span><br><span class="line">08</span><br><span class="line">        gridView = (GridView) findViewById(R.id.gridView);</span><br><span class="line">09</span><br><span class="line">        gridView.setAdapter(mAdapter);</span><br><span class="line">10</span><br><span class="line"></span><br><span class="line">11</span><br><span class="line">        fb = FinalBitmap.create(this);//初始化FinalBitmap模块</span><br><span class="line">12</span><br><span class="line">        fb.configLoadingImage(R.drawable.downloading);</span><br><span class="line">13</span><br><span class="line">        //这里可以进行其他十几项的配置，也可以不用配置，配置之后必须调用init()函数,才生效</span><br><span class="line">14</span><br><span class="line">        //fb.configBitmapLoadThreadSize(int size)</span><br><span class="line">15</span><br><span class="line">        //fb.configBitmapMaxHeight(bitmapHeight)</span><br><span class="line">16</span><br><span class="line">    &#125;</span><br><span class="line">17</span><br><span class="line"></span><br><span class="line">18</span><br><span class="line"></span><br><span class="line">19</span><br><span class="line">///////////////////////////adapter getView////////////////////////////////////////////</span><br><span class="line">20</span><br><span class="line"></span><br><span class="line">21</span><br><span class="line">public View getView(int position, View convertView, ViewGroup parent) &#123;</span><br><span class="line">22</span><br><span class="line">    ImageView iv;</span><br><span class="line">23</span><br><span class="line">    if(convertView == null)&#123;</span><br><span class="line">24</span><br><span class="line">        convertView = View.inflate(BitmapCacheActivity.this,R.layout.image_item, null);</span><br><span class="line">25</span><br><span class="line">        iv = (ImageView) convertView.findViewById(R.id.imageView);</span><br><span class="line">26</span><br><span class="line">        iv.setScaleType(ScaleType.CENTER_CROP);</span><br><span class="line">27</span><br><span class="line">        convertView.setTag(iv);</span><br><span class="line">28</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">29</span><br><span class="line">        iv = (ImageView) convertView.getTag();</span><br><span class="line">30</span><br><span class="line">    &#125;</span><br><span class="line">31</span><br><span class="line">    //bitmap加载就这一行代码，display还有其他重载，详情查看源码</span><br><span class="line">32</span><br><span class="line">    fb.display(iv,Images.imageUrls[position]);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/14/Android_Afinal框架/" data-id="cis0exhjs000i16uos50t9cl7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android-应用插件式开发解决方法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/14/Android-应用插件式开发解决方法/" class="article-date">
  <time datetime="2016-05-14T09:45:36.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/14/Android-应用插件式开发解决方法/">Android 应用插件式开发解决方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Android应用插件式开发解决方法</p>
<p>一、现实需求描述</p>
<p>一般的，一个Android应用在开发到了一定阶段以后，功能模块将会越来越多，APK安装包也越来越大，用户在使用过程中也没有办法选择性的加载自己需要的功能模块。此时可能就需要考虑如何分拆整个应用了。<br>二、解决方案提出</p>
<p>一般有两种方式，一种是将应用按照功能分拆成多个应用，用户需要哪个就下载哪个，都需要就都下载。应用之间，可以在代码层面做一定的关联，以共享部分信息。另一种方式，类似于其他平台插件的方式，用户可以在主应用中可以选择性的下载需要的插件，不需要该功能，则不需要下载。<br>第一种方式，只需要开发多个应用就够了。第二种方式稍微复杂，需要做很多额外的工作。这里我们简单讨论第二种方式的大致实现方法。<br>三、实现方法概述</p>
<p>有人可能会想到，是否可以像其他平台那样，下载一个类似于dll文件，或者jar包，就能自动识别并且加载该功能？可惜的是，在Android平台上是不允许直接动态加载jar包的，作者也没有想到类似办法。所以，想实现这种功能，还是要以独立APK的方式来加载。和第一种方式不同的是，从设计的角度，具体的插件是没有独立运行的入口的，也不允许有桌面图标存在，必须从主应用中打开，关闭后回到主应用（插件既然是APK，它安装完怎么会没有入口？怎么会没有桌面图标？QQ的跑酷等游戏不就是插件？不是就有图标入口？）。从用户的角度看，可以在应用中加载需要的功能并且使用，也就类似于其他平台插件的方式了。<br>为了实现这种方式，从设计的角度，就需要考虑清楚哪些功能作为独立的插件提供给用户，这里不再详述。下面从开发的角度说明大致需要做的工作。<br>Ø  主应用中需要开发的框架功能：<br>识别具体的插件是否已经安装（根据插件的package名）<br>如果已经安装要判断是否需要升级（服务器端获取最新的版本和本地的比较）<br>下载并且安装（或者升级）插件<br>卸载该插件<br>Ø  插件APK开发中需要注意的事项：<br>Manifest文件中不要提供启动的入口<br>Ø  主应用和插件之间交互的提示：<br>最好是使用相同的android:sharedUserId，插件可以方便的获取主应用的资源、数据库等等。<br>主应用可以以Intent方式启动具体的插件，同时带入Map类型参数或者json串参数，在插件APK中解析具体参数，实现业务逻辑。<br>三、其他说明</p>
<p>本博客内容并没有具体说明如何去实现，没有代码级别的说明。但是通过上面介绍的方式，开发者基本已经可以理解如何实现插件式的Android应用了。具体的，在开发过程中可能还会遇到很多问题，需要开发者自己摸索和完善。</p>
<p>///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////<br>框架已经放出：<br>Logo<br>android-application-plug-ins-frame-work<br>安卓应用程序插件化开发框架 -AAP Framework</p>
<pre><code>在android的项目开发中，都会遇到后期功能拓展增强与主程序代码变更的现实矛盾，也就是程序的灵活度。
由于linux平台的安全机制，再加上dalvik的特殊机制，各种权限壁垒，使得开发一个灵活多变的程序，变得比较困难，不像pc平台下那么容易。
瞅瞅elipse的插件，瞅瞅360的插件，在android下，我们一开始很难写好一个主程序，然后通过插件机制来应对以后的功能拓展，于是程序变得不那么灵活多变了。
比如一款android下的安全软件，新版本增加了一个功能，如短信拦截，往往会因为一个模块的增加，而重新编译一个apk包，这样周而复始，哪怕只增加50kb的功能代码，用户也需要升级一个完整的apk，往往是5~6M的体积。

最近思来想去，想到一个方法，既然tencent qq在android下面可以以apk的形式来换皮肤，这资源文件的拓展都可以这样简便的搞，为何功能性的拓展就不可以？
</code></pre><p>想出来了两种解决方案。<br>先来说说第一种。</p>
<p>demo下载在最后</p>
<p>先说分析思路。<br>     android下，默认的情况是，每个apk相互独立的，基本上每个应用都是一个dalvik虚拟机，都有一个uid，再配合上linux本身的权限机制，使得apk互通很难直接进行。但作为一个独立应用的集成，不管多少个apk，都可以并为一个单独的dalvik虚拟机，直观的反映给开发人员就是在shell下列出进程，那几个apk同时加载后，会一个进程存在。<br>     这主要就是工程的清单文件 Mainfest中配置了，只需要一句话，以我的测试demo为例：<br>复制代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">      package=&quot;org.igeek.plugintest.main&quot;</span><br><span class="line">      &lt;!-- 就是这句关键代码 --&gt;</span><br><span class="line">      android:sharedUserId=&quot;org.igeek.plugintest&quot;</span><br><span class="line">      android:versionCode=&quot;1&quot;      </span><br><span class="line">      android:versionName=&quot;1.0&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>复制代码</p>
<pre><code>在上面的代码中，android:sharedUserId是指共用一个uid，也就是，凡是这个属性相同的工程，都会共用同一个uid，这样，权限壁垒就消除了，dalvik也会融合为一个，可以测试一下，写几个工程，没有这个属性和有这个属性的情况下，同时运行，在列出当前进程，就直观的说明了。
</code></pre><p>   程序拓展的插件化，当然需要一个主程序，主程序是实现基本功能，以及UI，还有插件的检索以及插件的调用。<br>   这里贴出我demo中的主activity代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">复制代码</span><br><span class="line">  1 public class AndoirdpluginActivity extends ActivityGroup implements OnClickListener ,OnScrollCompleteListener&#123;</span><br><span class="line">  2     private LinearLayout llMainLayout;</span><br><span class="line">  3     </span><br><span class="line">  4     //workspace，看看luncher的源码，这个就是桌面那个多屏的实现</span><br><span class="line">  5     private WorkSpace wkMain;</span><br><span class="line">  6     private Button btnFindPlugins;</span><br><span class="line">  7     private CheckBox chbAttachMain;</span><br><span class="line">  8     </span><br><span class="line">  9     private LocalActivityManager m_ActivityManager;</span><br><span class="line"> 10     </span><br><span class="line"> 11     //这个bean的集合，就相当于插件的描述集合</span><br><span class="line"> 12 //每个bean也就是一个插件的各种描述</span><br><span class="line"> 13     private List&lt;PluginBean&gt; plugins;</span><br><span class="line"> 14     </span><br><span class="line"> 15     @Override</span><br><span class="line"> 16     public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line"> 17         super.onCreate(savedInstanceState);</span><br><span class="line"> 18         setContentView(R.layout.main);</span><br><span class="line"> 19         </span><br><span class="line"> 20         llMainLayout=(LinearLayout) findViewById(R.id.main_llMainLayout);</span><br><span class="line"> 21         wkMain=(WorkSpace) findViewById(R.id.main_wkMain);</span><br><span class="line"> 22         btnFindPlugins=(Button) findViewById(R.id.main_btnFindPlugins);</span><br><span class="line"> 23         chbAttachMain=(CheckBox) findViewById(R.id.main_chbAttachMain);</span><br><span class="line"> 24         </span><br><span class="line"> 25         m_ActivityManager = getLocalActivityManager();</span><br><span class="line"> 26         </span><br><span class="line"> 27         wkMain.setOnScrollCompleteLinstenner(this);</span><br><span class="line"> 28         btnFindPlugins.setOnClickListener(this);</span><br><span class="line"> 29     &#125;</span><br><span class="line"> 30 </span><br><span class="line"> 31     @Override</span><br><span class="line"> 32     public void onClick(View v) &#123;</span><br><span class="line"> 33         attachPlugin(findPlugins());</span><br><span class="line"> 34         btnFindPlugins.setVisibility(View.GONE);</span><br><span class="line"> 35     &#125;</span><br><span class="line"> 36     </span><br><span class="line"> 37     /**</span><br><span class="line"> 38      * 加载插件列表</span><br><span class="line"> 39      * @param plugins</span><br><span class="line"> 40 */</span><br><span class="line"> 41     private void attachPlugin(final List&lt;PluginBean&gt; plugins)&#123;</span><br><span class="line"> 42         Log.e(&quot;ydt&quot;, &quot;   &quot;);</span><br><span class="line"> 43         Log.e(&quot;ydt&quot;, &quot;----- 列出插件&quot;);</span><br><span class="line"> 44         this.plugins=plugins;</span><br><span class="line"> 45         for(final PluginBean plugin:plugins)&#123;</span><br><span class="line"> 46             Button btn=new Button(this);</span><br><span class="line"> 47             btn.setTextColor(Color.RED);</span><br><span class="line"> 48             btn.setText(plugin.getLabel());</span><br><span class="line"> 49             </span><br><span class="line"> 50             llMainLayout.addView(btn);</span><br><span class="line"> 51             //添加事件</span><br><span class="line"> 52             btn.setOnClickListener(new OnClickListener() &#123;</span><br><span class="line"> 53                 </span><br><span class="line"> 54                 @Override</span><br><span class="line"> 55                 public void onClick(View v) &#123;</span><br><span class="line"> 56                     boolean isAttack=chbAttachMain.isChecked();</span><br><span class="line"> 57                     </span><br><span class="line"> 58                     Intent it=new Intent();</span><br><span class="line"> 59                     it.setAction(plugin.getPakageName());</span><br><span class="line"> 60                     </span><br><span class="line"> 61                     //是否附加为view</span><br><span class="line"> 62                     if(isAttack)&#123;</span><br><span class="line"> 63                         //这里偷下懒，这是演示插件作为view附加到主程序中的</span><br><span class="line"> 64                         for(PluginBean plugin:plugins)&#123;</span><br><span class="line"> 65                             </span><br><span class="line"> 66                             Intent itt=new Intent();</span><br><span class="line"> 67                             itt.setAction(plugin.getPakageName());</span><br><span class="line"> 68                             ViewGroup view=(ViewGroup) (m_ActivityManager.startActivity(&quot;&quot;, itt)).getDecorView();</span><br><span class="line"> 69                             wkMain.addView(view);</span><br><span class="line"> 70                         &#125;</span><br><span class="line"> 71                         //一次性附加完毕算了，然后把按钮都删了，看着清净，这几个不是重点</span><br><span class="line"> 72                         llMainLayout.removeAllViews();</span><br><span class="line"> 73                         chbAttachMain.setVisibility(View.GONE);</span><br><span class="line"> 74                         wkMain.setToScreen(0);</span><br><span class="line"> 75                     &#125;else&#123;</span><br><span class="line"> 76                         //这里，不会把插件的窗体附加到主程序中，纯粹无用的演示</span><br><span class="line"> 77                         startActivity(it);</span><br><span class="line"> 78                     &#125;</span><br><span class="line"> 79                 &#125;</span><br><span class="line"> 80             &#125;);</span><br><span class="line"> 81             </span><br><span class="line"> 82         &#125;</span><br><span class="line"> 83     &#125;</span><br><span class="line"> 84     </span><br><span class="line"> 85     /**</span><br><span class="line"> 86      * 查找插件</span><br><span class="line"> 87      * @return</span><br><span class="line"> 88 */</span><br><span class="line"> 89     private List&lt;PluginBean&gt; findPlugins()&#123;</span><br><span class="line"> 90         </span><br><span class="line"> 91         List&lt;PluginBean&gt; plugins=new ArrayList&lt;PluginBean&gt;();</span><br><span class="line"> 92         </span><br><span class="line"> 93         </span><br><span class="line"> 94         //遍历包名，来获取插件</span><br><span class="line"> 95         PackageManager pm=getPackageManager();</span><br><span class="line"> 96         </span><br><span class="line"> 97         </span><br><span class="line"> 98         List&lt;PackageInfo&gt; pkgs=pm.getInstalledPackages(PackageManager.GET_UNINSTALLED_PACKAGES);</span><br><span class="line"> 99         for(PackageInfo pkg    :pkgs)&#123;</span><br><span class="line">100             //包名</span><br><span class="line">101             String packageName=pkg.packageName;</span><br><span class="line">102             String sharedUserId= pkg.sharedUserId;</span><br><span class="line">103             </span><br><span class="line">104             //sharedUserId是开发时约定好的，这样判断是否为自己人</span><br><span class="line">105             if(!&quot;org.igeek.plugintest&quot;.equals(sharedUserId)||&quot;org.igeek.plugintest.main&quot;.equals(packageName))</span><br><span class="line">106                 continue;</span><br><span class="line">107             </span><br><span class="line">108             //进程名</span><br><span class="line">109             String prcessName=pkg.applicationInfo.processName;</span><br><span class="line">110             </span><br><span class="line">111             //label，也就是appName了</span><br><span class="line">112             String label=pm.getApplicationLabel(pkg.applicationInfo).toString();</span><br><span class="line">113             </span><br><span class="line">114             PluginBean plug=new PluginBean();</span><br><span class="line">115             plug.setLabel(label);</span><br><span class="line">116             plug.setPakageName(packageName);</span><br><span class="line">117             </span><br><span class="line">118             plugins.add(plug);</span><br><span class="line">119         &#125;</span><br><span class="line">120         </span><br><span class="line">121         </span><br><span class="line">122         return plugins;</span><br><span class="line">123         </span><br><span class="line">124     &#125;</span><br><span class="line">125 </span><br><span class="line">126  </span><br><span class="line">127     /**</span><br><span class="line">128      * WorkSpace滚动到那个屏，会触发这个事件</span><br><span class="line">129      * 而worksapce中每一屏又是一个插件</span><br><span class="line">130      * 这个事件是用来列出当前屏幕插件所提供的应用，并且让用户调用</span><br><span class="line">131 */</span><br><span class="line">132     @Override</span><br><span class="line">133     public void onScrollComplete(final ScrollEvent e) &#123;</span><br><span class="line">134         try &#123;</span><br><span class="line">135             final Context context = createPackageContext(plugins.get(e.curScreen).getPakageName(), Context.CONTEXT_INCLUDE_CODE|Context.CONTEXT_IGNORE_SECURITY);</span><br><span class="line">136             llMainLayout.removeAllViews();</span><br><span class="line">137             //这几行，通过反射获取了当前插件的描述信息，如同大部分框架的xml一样，这里算是模拟了一下IOC控制反转</span><br><span class="line">138             Class clazz=context.getClassLoader().loadClass(plugins.get(e.curScreen).getPakageName()+&quot;.PluginApplication&quot;);</span><br><span class="line">139             Object o=clazz.newInstance();</span><br><span class="line">140             Map&lt;String,List&lt;String&gt;&gt;  r=(Map&lt;String, List&lt;String&gt;&gt;) clazz.getMethod(&quot;getDesciption&quot;).invoke(o);</span><br><span class="line">141             List&lt;String&gt; classes=r.get(&quot;classes&quot;);</span><br><span class="line">142             List&lt;String&gt; methods=r.get(&quot;methods&quot;);</span><br><span class="line">143             </span><br><span class="line">144             </span><br><span class="line">145             //这里，根据获得的插件所提供的功能，来生成几个按钮显示，供我们调用</span><br><span class="line">146             for(final String clas:classes)&#123;</span><br><span class="line">147                 for(final String method:methods)&#123;</span><br><span class="line">148                     Button btn=new Button(this);</span><br><span class="line">149                     </span><br><span class="line">150                     btn.setText(clas+&quot; -&gt; &quot;+method+&quot; 执行&quot;);</span><br><span class="line">151                     </span><br><span class="line">152                     </span><br><span class="line">153                     //点击后，就执行插件所提供的方法</span><br><span class="line">154                     btn.setOnClickListener(new OnClickListener() &#123;</span><br><span class="line">155                         </span><br><span class="line">156                         @Override</span><br><span class="line">157                         public void onClick(View v) &#123;</span><br><span class="line">158                             try &#123;</span><br><span class="line">159                                 Class c=context.getClassLoader().loadClass(plugins.get(e.curScreen).getPakageName()+&quot;.&quot;+clas);</span><br><span class="line">160                                 Object o1=c.newInstance();</span><br><span class="line">161                                 </span><br><span class="line">162                                 //这里注意，context实际上就是句柄，这里如果涉及到窗体，plugin的句柄其实是不行的，因为它没有可以</span><br><span class="line">163 //依附的窗体</span><br><span class="line">164                                 </span><br><span class="line">165 //这个context是plugin的，通过测试，dialog这类行不通,Toast是可以的，因为</span><br><span class="line">166 //Toast是依附于屏幕主窗口的</span><br><span class="line">167 //c.getMethod(method,Context.class).invoke(o1,context); </span><br><span class="line">168                                                         </span><br><span class="line">169 //这里则传递的是主程序的句柄</span><br><span class="line">170                                 c.getMethod(method,Context.class).invoke(o1,AndoirdpluginActivity.this);</span><br><span class="line">171                             </span><br><span class="line">172                             &#125; catch (Exception e) &#123;</span><br><span class="line">173                                 // TODO Auto-generated catch block</span><br><span class="line">174                                 e.printStackTrace();</span><br><span class="line">175                             &#125; </span><br><span class="line">176                         &#125;</span><br><span class="line">177                     &#125;);</span><br><span class="line">178                     llMainLayout.addView(btn);</span><br><span class="line">179                 &#125;</span><br><span class="line">180             &#125;</span><br><span class="line">181             </span><br><span class="line">182         </span><br><span class="line">183         &#125; catch (Exception e1) &#123;</span><br><span class="line">184             // TODO Auto-generated catch block</span><br><span class="line">185             e1.printStackTrace();</span><br><span class="line">186         &#125;</span><br><span class="line">187     </span><br><span class="line">188     &#125;</span><br><span class="line">189 &#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<pre><code>看注释吧，主要有两点
</code></pre><p>插件的扫描<br>        这种方案是，每个插件以一个单独的apk发布，这样可以在程序中很灵活的知道是否有新的插件，提示用户下载安装，插件的apk清单描述为Action为非Luncher，Category为Default。<br>        主程序侦听packgeManager的安装完成广播，之后扫描同包名（插件当然得这么定义了，只要通过packgeManager能判断是否为自己的插件就行）的apk，之后列出来，让用户选择是否加载。</p>
<p>插件的加载与调用<br>         在获取包后，通过调用系统的api可以得到 sharedUserId 与主程序相同的apk的context，也就是句柄，获得了句柄，通过这个context可以得到classloader，之后就简单了，如何知道这个插件提供什么功能？<br>         这个可以用xml描述，比如这个xml是插件apk的一个资源，就像spring这个框架一样。xml中描述了这个插件有哪些类，提供哪些方法，这些方法需要传入什么参数，返回什么类型。我的demo中为了方便，是用接口，每个插件有一个类提供一个相同的方法，来获取一个map集合，获得这个插件的描述。</p>
<pre><code>ok,到这里就知道加载的插件提供什么功能了。

在上面贴出来的代码中，是循环遍历每个插件，并把每个插件提供的功能以Button的方式显示给用户，点击按钮，就执行了插件的功能，执行时，并不是activity转向（这样就无意义了），而是在主程序自身的context句柄中执行，也就是在自身的窗体中执行。
代码中有一段注释，说明，如果插件有用到context时，记得传递进去的是主程序的context，这样窗体才能附加到这个句柄中，如果传递的是插件的context，它没有一个窗体实例，是无法将一些窗体附加进去的，无任何效果。
</code></pre><p>这里只提供思路，有时间的话研究一下，看能不能搞个通用的框架出来。还有另一种方法，不通过apk形式，以后会写出来。<br>      这里有一些待验证的问题，比如插件的权限问题，如果插件需要的一些权限在主程序中没有声明，会是个什么情况，能不能实时申请呢？这个需要高人指点。或者在主程序中把能声明的权限预先声明了也不错。还有就是native层代码的问题，如果插件包含了native层代码，会是个什么情况，这也需要验证。</p>
<p>这是demo下载：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://files.cnblogs.com/hangxin1940/android_plugin_program.rar</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/14/Android-应用插件式开发解决方法/" data-id="cis0exhiw000416uoxdj60cyc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IDE/">IDE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity3D/">Unity3D</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity3D-游戏/">Unity3D,游戏</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/兴趣/">兴趣</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/博客/">博客</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习，师傅/">学习，师傅</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微信-Js/">微信 Js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/心情/">心情</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/IDE/" style="font-size: 10px;">IDE</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Unity3D/" style="font-size: 10px;">Unity3D</a> <a href="/tags/Unity3D-游戏/" style="font-size: 10px;">Unity3D,游戏</a> <a href="/tags/兴趣/" style="font-size: 10px;">兴趣</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/学习，师傅/" style="font-size: 10px;">学习，师傅</a> <a href="/tags/微信-Js/" style="font-size: 10px;">微信 Js</a> <a href="/tags/心情/" style="font-size: 10px;">心情</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/05/24/兴趣视频教程/">兴趣视频教程</a>
          </li>
        
          <li>
            <a href="/2016/05/23/Idea快捷键/">Idea快捷键</a>
          </li>
        
          <li>
            <a href="/2016/05/16/流程图绘制和基本符号/">流程图绘制和基本符号</a>
          </li>
        
          <li>
            <a href="/2016/05/14/学习/">师傅的博客</a>
          </li>
        
          <li>
            <a href="/2016/05/14/心情/">心情</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 huanxingxyz<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>